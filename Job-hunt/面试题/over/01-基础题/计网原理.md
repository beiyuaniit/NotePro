# ==计算机网络==

## ==概述==

### 客户服务软件

- 客户软件
  - 被用户调用后运行，主动向远地服务器发起通信（请求服务）。
  - 客户程序必须知道服务器程序的地址。
  - 不需要特殊的硬件和很复杂的操作系统。

- 服务器软件
  - 一种专门用来提供某种服务的程序，可同时处理多个远地或本地客户的请求。
  - 系统启动后即自动调用并一直不断地运行着，被动地等待并接受来自各地的客户的通信请求。因此，服务器程序不需要知道客户程序的地址。
  - 一般需要强大的硬件和高级的操作系统支持。

### 对等连接软件

¨对等连接(peer-to-peer，简写为 P2P)是指两个主机在通信时并不区分哪一个是服务请求方还是服务提供方。

¨只要两个主机都运行了对等连接软件（P2P 软件），它们就可以进行平等的、对等连接通信。 

### 交换方式

- 交换：发送和接收信息的方式
- 电路交换

  - 2台电话机之间用一对电线连接，*N* 部电话机两两相连，需 *N*(*N* – 1)/2 对电线
  - 由于电路交换在通信之前要在通信双方之间建立一条被双方独占的物理通路（由通信双方之间的交换设备和链路逐段连接而成）
  - 优点

    - ①由于通信线路为通信双方用户专用，数据直达，所以传输数据的时延非常小。

    - ②通信双方之间的物理通路一旦建立，双方可以随时通信，实时性强。

    - ③双方通信时按发送顺序传送数据，不存在失序问题。

    - ④电路交换既适用于传输模拟信号，也适用于传输数字信号。

    - ⑤电路交换的交换设备（交换机等）及控制均较简单。

  - 缺点：
  - ①电路交换的平均连接建立时间对计算机通信来说嫌长。
      - ②电路交换连接建立后，物理通路被通信双方独占，即使通信线路空闲，也不能供其他用户使用，因而信道利用低。
  - ③电路交换时，数据直达，不同类型、不同规格、不同速率的终端很难相互进行通信，也难以在通信过程中进行差错控制。
- 分组交换
  - 过程
    - 在发送端，先把较长的报文划分成较短的、固定长度的数据段
    - 每一个数据段前面添加上首部构成分组。分组交换网以“分组”作为数据传输单元，依次把各分组发送到接收端
    - 分组交换网中的结点交换机根据收到的分组的首部中的地址信息，把分组转发到下一个结点交换机。
    - 最后，在接收端把收到的数据剥去首部恢复成为原来的报文。
  - 优点
    - ①加速了数据在网络中的传输。因为分组是逐个传输，可以使后一个分组的存储操作与前一个分组的转发操作并行，这种流水线式传输方式减少了报文的传输时间。此外，传输一个分组所需的缓冲区比传输一份报文所需的缓冲区小得多，这样因缓冲区不足而等待发送的机率及等待的时间也必然少得多。
    - ②简化了存储管理。因为分组的长度固定，相应的缓冲区的大小也固定，在交换结点中存储器的管理通常被简化为对缓冲区的管理，相对比较容易。
    - ③减少了出错机率和重发数据量。因为分组较短，其出错机率必然减少，每次重发的数据量也就大大减少，这样不仅提高了可靠性，也减少了传输时延。
    - ④由于分组短小，更适用于采用优先级策略，便于及时传送一些紧急数据，因此对于计算机之间的突发式的[数据通信]，分组交换显然更为合适些。
    - 不必先建立连接就能向其他主机发送分组
  - 不足
    - ①尽管分组交换比报文交换的传输时延少，但仍存在存储转发时延，而且其结点交换机必须具有更强的处理能力。
    - ②分组交换与报文交换一样，每个分组都要加上源、目的地址和分组编号等信息，使传送的信息量大约增大5%～10%，一定程度上降低了通信效率，增加了处理的时间，使控制复杂，时延增加。
    - ③当分组交换采用[数据报服务时，可能出现失序、丢失或重复分组，分组到达目的结点时，要对分组按编号进行排序等工作，增加了麻烦。若采用虚电路服务，虽无失序问题，但有呼叫建立、数据传输和虚电路释放三个过程。
- 报文交换
    - 分组交换的前身，发送消息整体（数据报）

### 路由器

- 处理分组过程
  - 把收到的分组先放入缓存（暂时存储）
  - 查找转发表，找出到某个目的地址应从哪个端口转发；
  - 把分组送到适当的端口转发出去。

### 性能指标

- ¨比特（bit）
  - 是计算机中数据量的单位，也是信息论中使用的信息量的单位。
- ¨数据率(data rate)
  - 即速率或比特率(bit rate)是计算机网络中最重要的一个性能指标。速率的单位是 b/s，或kb/s, Mb/s, Gb/s 等 
- ¨“带宽”(bandwidth)
  - 本来是指信号具有的频带宽度，单位是赫（或千赫、兆赫、吉赫等）。
  - ¨现在“带宽”是数字信道所能传送的“最高数据率”的同义语，单位是“比特每秒”，或 b/s (bit/s)。  

- ¨吞吐量(throughput)
  - 表示在单位时间内通过某个网络（或信道、接口）的数据量。
- ¨时延
  - 指数据（一个报文）从网络（或链路）的一端传输到另一端需要的时间；
- ¨发送时延 
  - 发送数据时，数据块从结点进入到传输媒体所需要的时间。
  - 等于=数据块长度（比特）/ 信道宽度（比特/秒）
- 传播时延
  - 数据在信道中需要传播一定的距离而花费的时间。
  - 等于=信道长度（米）/  信号传播速率（米/ 秒）
- 处理时延
  - 交换结点为存储转发而进行一些必要的处理所花费的时间。
- ¨排队时延
  - 结点缓存队列中分组排队所经历的时延。排队时延的长短往往取决于网络中当时的通信量。

- 信道利用率
  - 指出某信道有百分之几的时间是被利用的（有数据通过）。完全空闲的信道的利用率是零
  - 信道利用率并非越高越好。
    - 排队论的理论，当某信道的利用率增大时，该信道引起的时延也就迅速增加
    - 令 *D*0 表示网络空闲时的时延，*D* 表示网络当前的时延,*U* 是网络的利用率，数值在 0 到 1 之间
    - D=D0/(1-U)
    - ![信道利用率与时延关系](images\信道利用率与时延关系.png)
- 网络利用率
  - 则是全网络的信道利用率的加权平均值

### 网络分层

- 相互通信的两个计算机系统必须高度协调工作才行，而这种“协调”是相当复杂的
- 网络分层就是将网络节点所要完成的数据的发送或转发、打包或拆包，控制信息的加载或拆出等工作，分别由不同的硬件和软件模块去完成。这样可以将往来通信和网络互连这一复杂的问题变得较为简单。
- ¨“分层”可将庞大而复杂的问题，转化为若干较小的局部问题，而这些较小的局部问题就比较易于处理。（分治法）
- 分层的好处：各层之间是独立的，灵活性好，结构上可分割开，易于实现和维护，能促进标准化工作

### 七层模型

- 分层

  - ISO提出的OSI(Open System Interconnection)模型将网络分为七层，即物理层( Physical )、数据链路层(Data Link)、网络层(Network)、传输层(Transport)、会话层(Session)、表示层(Presentation)和应用层(Application)。

  - OSI模型共分七层:从上至下依次是 应用层指网络操作系统和具体的应用程序，对应WWW服务器、FTP服务器等应用软件 表示层数据语法的转换、数据的传送等 会话层 建立起两端之间的会话关系，并负责数据的传送 传输层 负责错误的检查与修复，以确保传送的质量，是TCP工作的地方。(报文) 网络层 提供了编址方案,IP协议工作的地方(数据包) 数据链路层将由物理层传来的未经处理的位数据包装成数据帧 物理层 对应网线、网卡、接口等物理设备(位)。


- 物理层
  - 物理层(Physical layer)是最低层。该层是网络通信的数据传输介质，由连接不同结点的电缆与设备共同构成。主要功能是:利用传输介质为数据链路层提供物理连接，负责处理数据传输并监控数据出错率，以便数据流的透明传输。
- 数据链路层
  - 数据链路层(Data link layer)是第2层。 主要功能是:在物理层提供的服务基础上，在通信的实体间建立数据链路连接，传输以"帧"为单位的数据包，并采用差错控制与流量控制方法，使有差错的物理线路变成无差错的数据链路。
- 网络层
  - 网络层(Network layer)是第3层。主要功能是:为数据在结点之间传输创建逻辑链路，通过路由选择算法为分组(packet, 也称数据包)通过通信子网选择最适当的路径，以及实现拥塞控制、网络互联等功能。
- 传输层
  - 传输层(Transport layer)是第4层。主要功能是向用户提供可靠的端到端(End-to-End)服务，处理数据包错误、数据包次序，以及其他一些关键传输问题。传输层向高层屏蔽了下层数据通信的细节，因此，它是计算机通信体系结构中关键的一层。
- 会话层
  - 会话层(Session layer)是第5层。主要功能是:负责维护两个结点之间的传输链接，以便确保点到点传输不中断，以及管理数据交换等功能
- 表示层
  - 表示层(Presentation layer)是第6层。主要功能是:用于处理在两个通信系统中交换信息的表示方式，主要包括数据格式变换、数据加密与解密、数据压缩与恢复等功能。
- 应用层
  - 应用层(Application layer)是最高层。主要功能是:为应用软件提供了很多服务，例如文件服务器、数据库服务、电子邮件与其他网络软件服务

### 五层模型

- 因特网协议栈共有五层:应用层、传输层、网络层、链路层和物理层。不同于OSI七层模型这也是实际使用中使用的分层方式。
- 物理层
  - 负责将比特流在结点间传输，即负责物理传输。该层的协议既与链路有关也与传输介质有关。
- 数据链路层
  - 负责将IP数据报封装成合适在物理网络上传输的帧格式并传输，或将从物理网络接收到的帧解封，取出IP数据报交给网络层
- 网络层
  - 负责将数据报独立地从信源发送到信宿，主要解决路由选择、拥塞控制和网络互联等问题。
- 传输层
  - 负责为信源和信宿提供应用程序进程间的数据传输服务，这一层上主要定义了两个传输协议，传输控制协议即TCP和用户数据报协议UDP
- 应用层
  - 支持网络应用，应用协议仅仅是网络应用的一个组成部分，运行在不同主机上的进程则使用应用层协议进行通信。主要的协议有:http、ftp、telnet、smtp、pop3等

## ==物理层==

### 通信方式

- 单工通信：单向传输
- 半双工通信：双向交替传输
- 全双工通信：双向同时传输

### 信道复用

- 频分复用
  - 主机在相同的时间占用不同的频率带宽资源
- 时分复用
  - 主机在不同的时间占用相同的频率带宽资源
- 统计时分复用
  - 对时分复用的一种改进，不固定每个用户在时分复用帧中的位置，只要有数据就集中起来组成统计时分复用帧然后发送
- 波分复用
  - 光传输的频分复用
- 码分复用
  - 发送正交的码片序列
- 空分复用

## ==数据链路层==

### 基本概念

- **链路**link)
  - 是一条无源的点到点的物理线路段，中间没有任何其他的交换结点
- **数据链路**(data link)
  -  除了物理线路外，还必须有通信协议来控制这些数据的传输。若把实现这些协议的硬件和软件加到链路上，就构成了数据链路
    - 常用的是使用适配器（即网卡）来实现这些协议的硬件和软件，一般的适配器都包括了数据链路层和物理层这两层的功能
- 功能
  - 数据链路层是为了克服物理层的物理传输质量不足而存在的
  - 其目的是为了实现两个相邻节点间的无差错传输
  - 从分层的角度，数据链路层利用了物理层提供的原始比特流传输服务，检测并校正物理层的传输差错，控制数据的传输流量，使在相邻节点之间构成一条无差错的链路，从而向网络层提供可靠的数据传输服务

### 封装成帧

- **数据链路层采用了被称为**帧(frame)的协议数据单元作为该层的数据传送逻辑单元
  - **为了实现诸如**差错控制、物理寻址和流量控制等功能，数据链路层首先要使自己所看到的数据是有意义的
  - 除了要传送的用户数据外，还要提供关于寻址、差错控制和流量控制等所必需的控制信息，而不再是物理层的原始比特流。
  - **数据链路层协议的核心任务就是根据所要实现的数据链路层功能来**规定帧的格式，即语法和语义

- 帧的示意图

  

  ![帧示意图](images\帧示意图.png)

  - ¨**帧中的语法成分被称为域或字段(****field)；**
  - ¨**帧浓缩了与数据链路层功能实现相关的各种机制**
  - ¨**帧提高了数据处理和传输的效率**
  - **不同的数据链路层协议的帧格式可能会存在微小的区别**

- 帧的地址
  - ¨**帧中的地址属于****物理或硬件地址**
    - **网卡地址(局域网)**
    - **链路标识(广域网)**
  - ¨**用于设备或机器的物理寻址**
  - ¨**能够在多个相邻结点之间确定一个接受目标*
- 成帧与拆帧
  - **成帧**：**在发送方，数据链路层从网络层获得分组（****Packet)****后，要加上必要的帧头与帧尾后传送给物理层，并通过物理层传送到接收方的数据链路层**
  - **拆帧**：**在接收方，数据链路层则必须去掉发送端数据链路层所加的帧头和帧尾部分，从中分离出网络层所需的分组**

### 帧的定界

- 标识帧的开始和结束
- 字节计数法
  - **在帧头中使用一个字段来****标明****帧内的字符数，通常该字段称为帧长字段**
  - 缺点
    - **如果发生传输错误，则可能****更改****帧长的值，从而导致帧的同步出现问题**（ 帧的长度被误读或出错
- 首尾标记法
  - **每一帧以**ASCII字符序列特殊的标志字节FLAG加Header开始，以LAGE加Trailer结束
  - 缺点
    - **帧完全依赖于**FLAG字符，而且若数据部分也出现了FLAG，则接收端就会错误判断帧边界

- **字符填充法**
  - ¨**在首尾标记法中，由于数据中可能会出现标志字节FLAG或者转义字符ESC，从而干扰帧的正常定界**
  - 发送端在数据中所遇到的FLAG前再插入一个附加的ESC，因此只要看FLAG前有没有ESC，就可以把它作为数据帧分界符的标志字节，与数据中出现的标志字节区分开来
  - 遇到的ESC前也会加一个ESC，而接收端则忽略两个连续ESC的前一个
- 位填充法
  - 每一帧使用一个特殊的位模式如“01111110”作为开始和结束标记
  - 发送端在数据中若遇到5个连续的“1”时，则在其后自动插队入一个“0”而不管原先后面是0还是1。该技术简称“逢五1插0”；接收端则忽略5个连续的“1”后面的“0”，简称“逢五1删0”。这样数据中就没有特殊的位模式
- **物理层编码违例法**
  - 利用物理层信息编码中未用的电信号来作为帧的边界。
  - 采用冗余编码技术，如曼切斯特编码，即对连续两个信号进行采样，可得到一个二进制位 
  - 数据0：低-高电平对 
  - 数据1：高-低电平对
  - 高-高电平对和低-低电平对没有使用，如在二进制编码中出现则称为编码违例，但这两种违例编码正好可用作帧界符，在令牌环网中使用编码违例格式
  - 出现正常的电平则是数据部分

### 差错控制

- 概述
  - **物理信道中所存在的各类噪声，会引起数据传输中的错误**
  - **差错控制就是通过发现传输中的错误，以采取相应的措施降低数据传输错误的影响**
  - **差错控制的核心是发送端对传送的数据信息加上与其满足一定关系的冗余码，形成一个加强的、符合一定规律的发送序列**

### 纠错码

- 海明距离
  - 编码的字节差异数
  - 例如，编码集{0000,0101,1010, 1111}的汉明距离为2，可以100%检测1比特差错
- 海明码是一种可以纠正一位差错的编码。它是利用在信息位为m位，增加k位冗余位，构成一个n=m+k位的码字，然后用k个监督关系式产生的k个校正因子来区分无错和在码字中的n个不同位置的一位错

### 检错码

- 奇偶校验码
  - 水平奇偶校验：
      在面向字符的数据传输中，在每个字符的7位信息码后附加一个校验位0或1，使整个字符中“1”的个数构成奇数个（奇校验）或偶数个（偶校验）
  - 垂直奇偶校验：
      在发送字符块的末尾附加一个校验字符，且该字符中的第i位是针对所有字符的第i位所进行的校验。
  - 垂直水平奇偶校验
      垂直奇偶校验和水平奇偶校验技术的综合。对每个字符作垂直校验，对整个字符块作水平校验
- 校验和（Check Sum）
  - 将发送的数据看成是二进制整数序列，并划分成一段段规定的长度（如8位、16位、32位等），计算它们的和，如计算和时有进位，则将进位加到最后的校验和中，并将校验和与数据一起发送；在接收端，重新计算校验和，并与接收到的原校验和比较
- 块校验码（Block Check Code）
  - 每个字符进行奇偶校验，然后把所有的字符（连同奇偶位）进行异或运算，运算结果即为其块校验码，通常发送端在发送完数据区的结束标志后发送BCC，接收端一边接收数据一边计算BCC，最后与接收到的BCC比较，以确认所接收到的数据正确与否
- 循环冗余校验码（CRC）
  - 多项式除法：被除多项式=除式*商+剩余多项式
  - 通信双方约定除式,也就是生成多项式，发送方将余式（余数）作为冗余信息发送给接收方
  - 接收方验证所收到的多项式能否为除式所整除，以判断传输过程是否出错

- 差错控制措施
  - 检错码不能自动纠正所发现的错误，需要提供一种与之相配套的错误纠正机制；
  - 反馈重发：当接收方检出错误的帧时，首先将错误帧丢弃，然后给发送方反馈信息，请求对方重发相应的帧。
  - 又称自动请求重传（automatic repeat request），简称ARQ。
  - 常见的实现方法：（下面会讲
    - 停止等待方式 
    - 连续ARQ方式

### 流量控制

- 概述
  - 由于系统性能的不同，如硬件能力（包括CPU，存储器等）和软件功能的差异，会导致发送方与接收方数据处理能力有所不同
  - 流量控制的作用是使发送方所发出的数据流量，使其发送速率不要超过接收方所能接收的速率
  - 流量控制的关键是需要有一种信息反馈机制，使发送方能了解接收方是否具备足够的接收及处理能力

### 滑动窗口

- 背景
  - 捎带应答（piggybacking）：将确认序号携带在数据帧中传输，提高线路的效率；
  - 推迟确认：当需要发送确认但没有要发送的数据进行捎带时，可以让确认信息推迟一小段时间再发送
- 要点
  - 允许发送端在没有收到前一个帧的确认时，就可以发送后续的帧；接收端可以对正确收到的若干个帧同时进行确认、
  - 发送进程维持一组帧序号，对应于一组已经发送但尚未被确认的帧，用一个发送窗口维持这些帧
  - 接收进程也维持一组帧序号，对应于一组允许接收的帧，用一个接收窗口维持这些帧序号
  - 每一个要发送的帧都包含一个序列号，其范围从0到某一个值。若帧中“序列号” 字段的长度为n，则序列号的最大值为2n-1
- 发送方
  - 维持一个发送窗口（sending window）：
  - 在发送窗口内保持着一组序列号，对应于允许发送的帧，形象地称这些帧落在发送窗口内。
  - 若发送窗口的大小为Ws ，则表明已经发送出去但仍未得到确认的帧总数不能超过Ws。
  - 发送窗口的上限对应当前已经发送出去但未被确认的最后一帧
  - 帧的确认帧到达后，发送窗口的下限加1——窗口向前滑动一个位置
- 接收方
  - 维持一个接收窗口（receiving window）：
  - 保持着一组序列号，对应于允许接收的帧，形象地称序列号落在接收窗口内的帧将允许被接收；
  - 接收窗口的大小不会超过发送方窗口大小。
  - 若下限帧被正确接收，则接收窗口向前滑动一个位置，即窗口的上下限各加1，使一个新序列号落入窗口内，同时给发送方返回一个确认帧

- 当发送窗口和接收窗口的大小都等于1时，就是停止等待协议

### 服务类型

- **无确认无连接**
  - —当错误率很低,恢复留给高层,对实时通信很适合.绝大多数局域网如以太网采用
  - 源机器向目标机器发送独立的数据帧，而目的机器不对收到的帧作确认。
    由于线路上的噪声而造成的帧丢失，数据链路层不作努力去恢复，而将该工作留给上层（通常为传输层）。
    事先不需要建立连接，事后也不需要释放。
    适用于误码率较低的信道，如大多数的局域网中。
    实现这类服务的数据链路层协议通常比较简单 
- **有确认无连接**
  - —超时重发,使用于不可靠信道,如无线系统802.11（Wifi）
  - 事先不存在建立连接，事后也不存在释放
    源机器向目标机器发送独立的数据帧，但目的机器对收到的每一帧作确认。
    若某个确定的时间间隔内未能收到确认帧（超时），则发送方自动重发，
    适用于无线通信系统之类的不可靠信道。
    协议较实现无确认无连接服务的协议复杂
- ¨**面向连接**
  - —为网络层进程提供了可靠的位流.适用于长距离且不可靠的链路。比如卫星信道。
  - 源机器和目标机器在发送每一帧时都被编号，并确保每个帧都被收到且只会被收到一次（无重复帧）
  - 传送数据前，事先要建立一条连接。
    在连接上所传送的每一帧都要编上号，提供相应的确认和流量控制机制来保证每一帧都只被正确地接收一次，并保证所有帧都按正确的顺序被接收 。
    数据传输完成之后，需要释放所建立的连接。 
    真正为网络层提供了可靠的无差错传输服务。
    适用于误码率较高的不可靠信道，如某些广域网链路。
    协议的实现复杂度及实现代价相对最高

### 数据链路层协议

#### 无限制单工信道协议

- 在这样理想化的条件下,数据的传输就非常简单(不需要有流量控制,也不需要有差错控制)。

- 发送方

  1）从网络层接受一个分组；

  2）将分组装入帧的信息域；

  3）将帧传给物理层；

  4）返回1）

- 接受方

  1）等待帧到达事件；

  2）从物理层接受一个帧；

  3）从帧中取分组传给网络层；

  4）返回1）

#### 单工-停等协议

- 仍然假定信道不会出错，但需要进行流量控制。在这时引入反馈机制，要求接收端对于收到的每个帧都要给出响应，同时发送端在发出一帧后必须收到该帧的响应后才能发送下一个帧（停-等）

- 发送方

  1）从网络层接受一个分组；

  2）将分组装入帧的信息域；

  3）将帧传给物理层；

  4）等待响应帧，并在收到后返回1）

- 接受方

  1）等待帧到达事件；

  2）从物理层接受一个帧；

  3）从帧中取分组传给网络层；

  4）回送响应帧并返回1）

#### 有噪声信道单工-停等协议

- 假设信道会出错，而且接收端处理能力也有限，即同时需要差错控制和流量控制。
  协议要点：
  采用协议2中的停-等方式；
  发送方每次只发送一个帧，当这个帧被正确接收后才能发送下一帧，若该帧未在规定的时间内得到确认（超时），则重发该帧；
  接收端对每个收到的帧进行校验，对正确收到的帧发回确认，错误的帧丢弃；
  由于需要区分新、旧两个帧，因此要使用1比特的帧序号

#### 停止-等待ARQ协议

- 一位滑动窗口协议

- 窗口设置
  滑动窗口最大值: MAX-SEQ=1
  通信双方初始值: seq=0, ack=1 (期待接收seq=0)

- 窗口滑动机制
  A首先发送数据帧(seq=0, ack=1, A0)
  B收到A0,发送捎带确认帧(seq=0, ack=0, BO)
  A收到对AO的确认,滑动窗口,发送帧(seq=1, ack=0, A1)

- 特点
  序列号seq和确认值ack“0”“1”交替
  滑动窗口长度W=1,收到确认才移动窗口
  保证按顺序将接收到的正确帧只一次上交网络层

- 要点

  连续出现相同发送序号的数据帧，表明发送端进行了超时重传。
  连续出现相同序号的确认帧，表明接收端收到了重复帧。 
  发送端在发送完数据帧时，必须在其发送缓存中暂时保留这个数据帧的副本。
  这样才能在出差错时进行重传。只有确认对方已经收到这个数据帧时，才可以清除这个副本

- 发送端对出错的数据帧进行重传是自动进行的，因而这种差错控制体制常简称为 ARQ (Automatic Repeat ReQuest)，自动重传请求

- 优点

  - 简单

- 缺点

  - 通信信道的利用率不高

#### 后退N帧ARQ协议

- 发送方
  - 连续发送至发送窗口满口
  - 进行超时重传，重发出错帧以及其后续帧
- 接收方
  - 接收窗口为1，对出错帧不确认(引发超时)
  - ¨丢弃错帧,其后续帧因不是期望接收帧也被丢弃
- 重传帧数多,适于信道出错率较少的情况

#### 选择重传ARQ协议

- 增加了接收窗口大小，接收已经正确到达接收端的数据帧，只要求发送方重传所缺帧，等到所缺序号的数据帧收到后再一并送交主机
- 重传帧数少,适于信道质量不好的情况

### 局域网

- 特点
  - 网络为一个单位所拥有
    地理范围和站点数目均有限 
- 优点
  - 具有广播功能，从一个站点可很方便地访问全网
    局域网上的主机可共享连接在局域网上的各种硬件和软件资源 
    便于系统的扩展和逐渐地演变，各设备的位置可灵活调整和改变
    提高了系统的可靠性、可用性和生存性

### 网卡

- 网络接口板又称为通信适配器(adapter)或网络接口卡 NIC (Network Interface Card)，或“网卡”
- 功能
  - 数据的封装与解封    发送时将上一层交下来的数据加上首部和尾部，成为以太网的帧。接收时将以太网的帧剥去首部和尾部，然后送交上一层。 
  - 链路管理    主要是以太网中CSMA/CD 协议的实现。 
  - 编码与译码    如曼彻斯特编码与译码。 

### 共享信道

- 信道分配问题
  
  - 若多个设备在共享的广播信道上同时发送数据，则会造成彼此干扰，导致发送失败
- ¨静态分配
  - 只要一个用户得到了信道就不会和别的用户冲突。
    - 如FDM,TDM
  - 数据流量具有突发性和间歇性，信道利用率差
- 动态分配
  - 称为多路访问（Multiple Access）或多点接入，指多个用户共用一条线路，而信道并非是在用户通信时固定分配给用户，这样的系统又称为竞争系统。
  - 如ALOHA协议、CSMA协议 

- 五个关键假设

  - 站模型

    由N个独立的站组成，每个站有一个可以产生待发送帧的程序或用户。一旦生成一帧，该站就被阻塞，直到帧被成功传出

  - 单通道假设

    所有通信都通过单个信道进行。所有的站都在该信道上发送和接收信息。尽管软件可赋予各站优先级，但就硬件来说，各站是平等的

  - 冲突假设

    若两帧同时发送，它们会相互重叠，使信号难以辨认。所有的站都能检测到冲突。冲突的帧必须事后重发。除了冲突产生的差错外，不再有其他任何差错

  - 发送时间假设：
    连续任意时刻可发送：帧能在任何时候开始发送。没有主时钟将时间分隔为离散的发送区间
    分槽时间：时间被分为离散的区间（时隙）。帧总是在时隙开始的一瞬间开始发送。一个时隙内可发送0，1或多个帧，它们分别对应空闲时隙、成功时隙、发生冲突

  - 载波检测：
    有载波检测：所有站在使用信道以前都可以检测到信道是否正在使用。若忙，其他站不会去使用它，直到它变得空闲
    无载波检测：各站在使用信道前不检测信道，只是盲目地发送，事后才能确定本次传送是否成功

  

### 共享信道动态分配协议

#### 纯ALOHA协议

- 思想

  - 用户只要有数据待发，就让他们发

    当产生冲突，使帧受损时，发送方只要侦听信道就会知道

    若帧遭破坏，则发送方随机等待一段时间后重发

#### 分槽ALOHA协议

- 思想
  - 把使用信道的时间分成离散的时间槽，槽长为一个帧所需的发送时间，每个站点只能在时间槽开始时才允许发送，其他过程与纯ALOHA协议相同。
  - 冲突主要发生在时间槽的起点，一旦发送成功就不会出现冲突，分槽ALOHA大幅度降低了冲突的可能性，信道利用率比纯ALOHA提高了约一倍

#### 载波侦听多路访问CSMA协议

网络站点侦听载波是否存在（即有无传输）并相应动作的协议

#### 1-持续CSMA

- 过程

  当一个站点要传送数据时，它首先侦听信道，看是否有其他站点正在传送
  若信道忙，则持续等待直到信道空闲，便将数据送出
  若发生冲突，站点就等待一个随机长的时间，然后重新开始

- 此协议被称作1-持续CSMA，是因为站点一旦发现信道空闲，其发送数据的概率为1
- 传输延时对协议性能的影响：
  - 传输延时越长，冲突可能性越大，系统性能也就越差
  - 即使传输延时为0，仍然有可能发生冲突

#### P-持续CSMA

- 过程

  一个站点在发送之前，首先侦听信道，若空闲，便以概率p传送，而以概率q=1-p把该次发送推迟到下一时隙

  若下一时隙仍空闲，便再次以概率p传送，而以概率q=1-p把该次发送推迟到下下一时隙

  此过程一直重复，直到发送成功或另外一站开始发送为止

- 用于分隙信道

#### 非持续CSMA

- 过程

  在该协议中，站点发送前会侦听信道的状态

  如果没有其他站点在发送，它就开始发送

  但如果信道正在使用中，该站点将不再继续侦听信道，而是等待一个随机的时间后，再重复上述过程

#### 有冲突检测的CSMA/CD

- 过程

  若两站侦听到信道空闲并同时开始传送，几乎会同时检测到冲突
  一旦检测到冲突，不是继续传完帧，而是尽快停止

## ==网络层==

### 服务模式

- 数据报机制

  - Internet团体（best-effort service）主张采用无连接的设计思路，即尽力而为服务（best-effort service），将差控流控等交给端主机实现 ，尽量使网络层简单快速  

  - 过程

    •本质上是一种基于存储-转发的分组交换过程

    •发送端无需事先建立逻辑连接，事后也无需释放连接

    •发送端在发送分组前需要在该分组中附上完整的源-目的地址对

    •中间节点依据分组中的目的地址和相关策略（例如，自身维护的路由表）为分组查找接收邻居

    •接收邻居收到分组后，若发现分组中的目的地址是自身则提交上层协议处理，否则执行中间节点的操作

- 虚电路机制

  - 传统网络营运商（例如电话公司）主张采用面向连接的设计思路，除了端主机，网络设备也参与到可靠传输服务的保障中

  - 过程

    在发送分组之前，必须首先建立一条从源路由器到目的路由器之间的路径
    这条面向连接的路径即为一条虚电路（VC），而子网称为虚电路子网
    虚电路需要作为连接路径上中间节点的路由器来维护，并且保存在这些路由器的内部表中
    每个分组都只需包含一个标识符，指明了它属于哪一个虚电路，而不需要包含源-目的端地址
    虚电路在使用完后，可以立即释放，叫交换虚电路（或呼叫虚电路）；若在一定时间内不需要反复建立-使用-释放操作的，则称为永久虚电路

- 对比
  ![虚电路和数据报](images\虚电路和数据报.png)

### 网络路由

- 概念
  - 当端到端数据传输无法通过单一物理介质实现时，则需要中间节点进行转发
  - 当中间节点存在多条出口链路，则需要确定能到达目的端的最优出口是哪个
    - 具备路由功能的设备能为每个可能的目的地维护一个最优出口，并在需要时提供查询服务
  - ¨相隔遥远的端到端传  输需要借助广域网连通，因此，物理层通信不可能是单一介质
  - ¨规模大的局域网通常也逻辑隔离成许多网段，处在不同网段的端到端传输需要网络设备中转，因此，物理层通信也不可能是单一介质
  - 利用路由器进行网络互连和路由选择

### 路由算法

- 路由算法分类
  - 非自适应路由算法（或称静态路由算法）：不根据实测或估计的网络的当前通信量和拓扑结构来作路由选择；路由表是事先计算好的，在网络启动后下载到路由器中
  - 自适应路由算法（或称动态路由算法）：根据实测或估计的网络的当前通信量和拓扑结构来作路由选择
- 最短路径算法：Dijkstra 算法
  - 若已知一个网络拓扑，则通过该算法可以方便地求得任意两个节点之间的最短通信路径，因此，可用于设计静态路由算法，也通常用在一些动态路由算法的设计中
  - 基本思想——构建子网的拓扑图，图中的每个结点代表一个路由器，每条弧代表一条通信线路，指定两个结点，使用Dijkstra算法在图中找出它们之间的最短路径
  - 不断搜索当前节点所能到达的下一个最近节点
- 扩散法
  - 基本思想——把收到的每一个包，向除了该包到来的线路外的所有输出线路发送
  - 主要问题——会生大量重复包
  - 解决措施
    - 每个包头包含站点计数器，每经过一站计数器减1，为0时则丢弃该包
    - 记录包经过的路径
  - 扩散法的一种改进——选择性扩散算法
    - 将进来的每个包仅发送到与正确方向接近的线路上
  - 应用情况
    具有极好的健壮性，可用于网络通信条件恶劣的环境下
    可作为衡量标准评价其它路由算法
    过于浪费带宽，故作为一种独立路由方案在实际上很少被直接采用
    通常被间接用在其它路由算法的设计中
- 动态路由选择通常有三种实现策略
  独立路由选择
  选择节点仅根据自己搜集到的有关信息做出路由选择的决定，与其它节点不交换路由选择信息
  集中路由选择
  节点路由表由路由控制中心RCC(Routing Control Center)定时根据网络状态计算、生成并分送到各相应节点
  分布路由选择
  所有节点定期地与其每个相邻节点交换路由选择信息或将自身信息在子网内发散
  距离矢量路由与链路状态路由算法都是基于分布路由选择

### 路由分级

- 路由分级的缘由
  随着网络规模的增长，路由器的路由表也成比例地增长
  不断增长的路由表需要占用大量内存，需要更多CPU时间来查找路由表的表项，需要更多的带宽来发送有关的状态报告
  因此，在上述情况发生，路由选择过程必须进行分级
- 路由分级的做法
  将路由器划分成区域——每个路由器知道如何将分组路由到自己所在区域内的目标地址，但不必了解区域外的情况
  根据网络规模确定分级层数——对于大型的网络，一个两级的分层结构可能还不够；可能有必要组织成群，将群组织成区，将区组织成组
- 路由分级的利弊
  路由分级虽然节省了空间，但也可能付出了代价
  代价的形式可能是路径长度的增加

- 分级路由的一个示例——一个有720个路由器的子网
  若分两级，24个区域，每个区域30个路由器，则每个路由器需要的表项数：30个本地，23个远程，共53个路由表项。
  若分三级，8个群，每个群9个区域，每个区域10个路由器，则每个路由器需要的表项数：10个本地，8个到群内其它区域，7个到其它群，共25个路由表项。

### 网络路由的性能指标

- 优化目标
  - 正确性
    可指根据路由算法得到的路由表项能反映网络实际拓扑
    算法必须是正确和完整的
  - 简单性
    可指路由算法的逻辑简单，运行开销小
    计算简单，不增加太多开销
  - 健壮性
    可指路由算法应对各种拓扑结构和流量方面变化的能力
    能适应通信和网络拓扑的变化
  - 稳定性
    可指路由算法会达到平衡，并保持平衡的能力
    收敛到可接受的解
  - 公平性
    可指路由算法能为所有可能目的地提供路由选项
    应对所有用户公平
  - 最优性
    找到“最好”的路由，与具体的优化目标相关，若涉及多目标，则可能冲突而需要折
    同时与最优性与公平性也可能是冲突的

- 衡量指标
  - 结点数量、或跳数
    地理距离
    传输延迟、或数据包平均延迟、或路由器的排队长度 
    吞吐量
    可靠性：线路出错率
    带宽：最大带宽
    路由器的负载
    通信成本 
    距离、信道带宽等参数的加权函数

### 各种路由

#### 广播路由

- 广播路由的目的——将消息发送给子网的每个节点
- 广播路由的实现思路
  - 第一种思路
    不要求子网具有任何特殊特性的广播方式
    只让源机器简单地给每个目标单独发送一个分组
    缺点是浪费带宽，同时要求源机器拥有所有目标机器的完整地址列表
  - 第二种思路
    采用扩散法
    虽然不适合于普通的点到点通信，但对广播而言，值得考虑
    缺点是会产生太多分组，消耗太多带宽
  - 第三种思路
    采用多目标路由
    每个分组或者包含一组目标，或者包含一个位图，由该位图来指定所期望的目标
    当分组到达一个路由器时，路由器会根据目标确定必要输出线路，然后为每一条必要线路生成一个副本，在这份副本中只包含了那些使用了这条线路的目标

#### 多播路由

- 多播路由简介
  多播路由的目的——将消息发送给子网中的一个指定组中的节点
- 多播路由关注的问题
  要求对组进行管理
  需要一种办法来创建和销毁组，并且允许节点加入或离开组
  多播路由算法应关心，当一个节点加入组时，它需要把这个事实告诉它的节点，因此知道哪些节点属于哪些组很重要
  当节点与组之间的从属关系发生变化时，节点必须将这些变化告诉路由器，或者由路由器定时询问相关节点

#### 移动主机路由

- 移动主机路由简介
  固定主机：永远不会移动
  迁移主机：从一个固定点移到另一个固定点
  漫游主机：在移动中执行计算
  移动主机指后两类
  固主场所：主机永久不变的位置，用主地址表示
  在包含移动主机的系统中，路由算法的目标是，使用移动主机的主地址给它们发送分组，而且无论它们在哪里，分组都能够被递交给它们
  这里的关键是如何找到这些主机
- 整个网络被分成许多小的单元，称为区域，通常一个区域是一个LAN或无线蜂窝单元。每个区域有一个或多个外部代理。每个区域有一个本地代理
  外部代理：记录下所有当前正在访问该区域的移动主机
  本地代理：记录下那些主场所在本区域，但当前正在访问其他区域的主机
- 移动主机路由简介
  当一台新的主机进入一个区域，必须在外部代理处注册
  每个外部代理周期性广播一个分组，宣布它的存在以及地址；一个新到达的主机可被动等待这样的消息，也可主动询问
  新到达的主机向外部代理请求注册，并提供自己的主地址等信息
  外部代理与新到达的主机的本地代理进行确认
  本地代理在做相关确认后进行回复
  外部代理在得到满意回复后，向新到达的主机通告注册完成

#### Ad Hoc网络路由

- 前面介绍主机移动路由时，路由器是固定的
  Ad Hoc网络路由是指路由器本身是移动情况下路由工作是如何进行的
  在下列情况下，路由器本身可能移动
  在没有网络基础设施的战场上使用的军用设备
  在大海航行的船只
  在地震中基础设施被破坏后，那些负责急救工作的人所使用的设备
  一群配备了便携式电脑或移动智能终端的人聚集在一个没有网络接入基础的地区
  在上述情况，每个节点包含了一个路由器和一个主机，往往是同一台机器

- Ad Hoc网络路由的实现思路
  主动式路由更新方式——按事先策略主动发起路由更新操作，无论Ad Hoc网络拓扑是否变化，也无论是否有节点需要寻路，也称表驱动式路由更新方式
  被动式路由更新方式——当节点需要发送数据而找不到到达目的地的有效路由时，则发起路由更新操作，也称按需路由更新方式3

#### 距离矢量路由

- 距离矢量路由算法
  也称为分布式Bellman-Ford算法和Ford-Fulkerson算法

- 工作原理
  每个路由器维护一张表
  表中给出了到每个目的路由器已知的最短“距离”和相应输出线路
  通过与相邻路由器交换距离信息来更新表

  每个路由器节点有义务与它的邻居交换路由表信息
  每个路由器节点仅依据获得的邻居路由表信息来更新自己的路由表

- “距离”的可能含义
  从源到目的路由器的站点数
  从源到目的路由器的估计传输延迟
  路由排队的分组估计总数或类似的值

- 无穷计算问题

  - 距离矢量路由算法的缺点是收敛较慢，路由变化的消息不能很快传播到所有的节点
    尤其是链路或节点发生故障后，需要经过很长时间才能被发现，致使节点在一个较长时间里使用不正确的路由信息，即出现无穷计算问题

  - 解决的方法：规定一个代价的上限，若达到，则认为目的地不可达

#### 链路状态路由

- 基本思想
  每个节点将自身局部链路状态信息在全网进行通告
  每个节点可获得关于全网的拓扑信息，得知网中所有的节点、各节点间链路连接和各条链路的代价（时延、费用等）
  每个节点将这些拓扑信息抽象成一张带权无向图，然后利用最短路径算法计算出从自身到其它每个节点的最短路径
- 工作过程
  算法执行者发现它的邻居节点，并知道其网络地址
  测量到各邻居节点的延时或开销
  构造一个分组，分组中包含所有它刚刚知道的信息
  将这个分组发送给所有其它的节点（即路由器）
  计算出到每一个其它路由器的最短路径

### 自治系统AS

- 定义
  - 在单一的技术管理下的一组路由器，而这些路由器使用一种 AS 内部的路由选择协议和共同的度量以确定分组在该 AS 内的路由，同时还使用一种 AS 之间的路由选择协议用以确定分组在 AS之间的路由
- 从自治系统 AS的角度，路由协议分为：
  - 内部网关协议 IGP (Interior Gateway Protocol)  
    在一个自治系统内部使用的路由协议
    例如，RIP 和 OSPF 协议
  - 外部网关协议 EGP (External Gateway Protocol) 
    若源站和目的站处在不同的自治系统中，当数据报传到一个自治系统的边界时，就需要使用一种协议将路由选择信息传递到另一个自治系统中
    这样的协议就是外部网关协议 BGP
    例如，BGP-4协议

### 域内路由协议

#### 路由信息协议 RIP

- (Routing Information Protocol) 是内部网关协议 IGP 中最先得到广泛使用的协议
  RIP 是一种分布式的、基于距离向量路由算法实现的Internet路由协议
  RIP 协议要求网络中的每一个路由器都要维护从它自己到其它每一个目的地的距离记录

- 具有距离向量路由算法的固有特点
  在小型网络中运行良好
  当网络规模变大，则性能变差，遭受无穷计数问题，收敛速度慢

- 基本原理

  RIP协议以跳数作为度量标准，基于距离向量算法更新路由

  RIP路由信息包先需要封装为传输层的UDP报文，再交由网络层封装为IP分组并传送

  RIP协议通过对从源到目的地的最大跳数加以限制来防止形成路由环路，最大值为15，若超过15，则认为目的地不可达

  RIP协议使用了一些计时器来控制其性能

- 优缺点
  - 优点
    实现简单
    开销较小
  - 缺点
    RIP 限制了网络的规模，它能使用的最大距离为 15（16 表示不可达）
    路由器之间交换的路由信息是路由器中的完整路由表，因而随着网络规模的扩大，开销也就增加
    “坏消息传播得慢”，使更新过程的收敛时间过长

#### 开放式最短路径优先OSFP

- Open Shortest Path First

- 区域 (area) 
  为了使 OSPF 能够用于规模很大的网络，OSPF 将一个自治系统再划分为若干个更小的范围，叫做区域，见下图
  每一个区域都有一个 32 位的区域标识符（用点分十进制表示）
  区域也不能太大，在一个区域内的路由器最好不超过 200 个 

- 基本操作

  OSPF让每一个路由器用数据库描述分组和相邻路由器交换本数据库中已经有的链路状态摘要信息
  OSPF使用可靠的扩散法——第一次先发给相邻的三个路由器，这三个路由器收到的分组再进行转发，可靠扩散法在收到更新分组后要发送确认

### 域间路由协议

#### 边界网关协议BGP

- 概述

  BGP使处于不同自治系统的路由器能够互相协作、交换路由信息
  不同的AS可能采用不同的度量方案
  不同的AS也可能有不同的优先级别
  一个AS也可能有禁止使用某些其它AS的限制政策
  例如，出于信息安全方面的考虑，将某些AS列为禁止通过的区域
  又如，出于租赁关系，由某个AS承担中转传输任务
  一对BGP路由器通过建立传输层的TCP连接相互通信

- 配置

  在配置BGP时，每个自治系统的管理员要选择至少一个路由器（通常是BGP边界路由器）作为该自治系统的“BGP发言人”
  一个BGP发言人与其它自治系统中的BGP发言人交换路由信息，如增加的路由、撤销过时的路由、差错信息等 

- 算法

  BGP 协议采用路径向量算法
  路径向量算法尽管与距离向量算法类似，但有两点不同
  舍弃了路由度量值，不包含距离或耗费的估计值
  每个路由信息块列出沿某路由到达目标网络要经过的所有AS
  路由通告消息中携带完整的路径，易于让接收路由器发现和打破路由循环



### IP

- IP协议概述
  - 因特网是全球最大的互联网，从OSI五层模型的最低二层（物理层、数据链路层）来看，技术细节极其异构多样
  - IP协议目前存在两个版本在同时使用：IPv4和IPv6
  - 无论什么样的网络互联，只要网络节点用IP地址进行标识，将待传输数据按IP协议格式封成IP分组，并依据IP分组中的目的IP地址查询路由表得到IP分组传送的下一站，便有可能一步一步被送到目的地
  - Internet协议（IP，Internet Protocol）-将整个Internet黏合在一起的网络层协议，提供一种尽力而为地把数据包从源端传输到接收方的方法

- IP在不同网络间传输分组的过程

  ![IP传输分组过程](images\IP传输分组过程.png)

### IPV4

- 数据报结构

  - 头部最少20字节，最多60字节

  ![IP数据包结构](images\IP数据包结构.png)

- IPV4地址

  - IPv4地址长度为32比特，按8比特一组，可分成4组
    每组8比特二进制串可以转换为0～255之间的一个十进制数来表示
    4组数之间用点(.)隔开，即点分十进制格式

  ![IPv4地址](images\IPv4地址.png)

- 地址分类

  - IPv4地址按前几位的类别比特分成A、B、C、D、E五类

    - A、B、C类地址为单播地址
      D类地址为组播地址
      E类地址保留，以备将来的特殊用途
      A、B、C三类地址可以分为网络号和主机号两部分

    ![IPV4地址分类](images\IPV4地址分类.png)

  - A、B、C三类地址的指派范围 

    ![ABC类地址指派范围](images\ABC类地址指派范围.png)

    - e

  - 特殊的地址

    ![特殊的地址](images\特殊的地址.png)

    ![特殊地址1](images\特殊地址1.png)

  - 私有地址

    - 私有地址不被正式的分配给任何人
      也不应该被使用在自己网络的外部机构(即Internet网上)

      也就是用于自己的网段

    - A类网：从10.0.0.0到10.255.255.255
      B类网：从172.16.0.0到172.31.255.255
      C类网：从192.168.0.0到l92.168.255.255 

- 地址分为两级

  - 网络号和主机号分离好处
    - IP 地址管理机构在分配 IP 地址时只分配网络号，而剩下的主机号则由得到该网络号的单位自行分配，这样就方便了 IP 地址的管理
    - 路由器仅根据目的主机所连接的网络号来转发分组（而不考虑目的主机号），这样就可以使路由表中的项目数大幅度减少，从而减小了路由表所占的存储空间
  - 通信时还是要知道完整的IP地址和端口号

- 地址分为三级

  - 子网划分

    - 给每一个物理网络分配一个网络号会使路由表变得太大因而使网络性能变坏
    - 两级的 IP 地址不够灵活

    - 从 1985 年起在 IPv4 地址中又增加了一个“子网号字段”

      使两级的 IPv4 地址变成为三级的 IP 地址

      这种做法叫做划分子网 (subnetting)

  - 划分子网的基本思路

      划分子网纯属一个单位内部的事情

      单位对外仍然表现为没有划分子网的网络

      从主机号借用若干个位作为子网号 subnet-id

      主机号 host-id 也就相应减少了若干个位

    ![划分子网](images\划分子网.png)

  - 使用

    - 在划分了子网情况下，路由器在和相邻路由器交换路由信息时，必须把自己所在子网的子网掩码告诉相邻路由器

      路由器的路由表中的每一个项目，除了要给出目的网络地址外，还必须同时给出该子网络的子网掩码。

      若一个路由器连接在两个子网上，就拥有两个网络地址和两个子网掩码

- 子网掩码

  - 从一个 IP 分组的首部并无法判断源主机或目的主机所连接的网络是否进行了子网划分
    使用子网掩码 (subnet mask) 可以找出 IP 地址中的子网部分
  - 子网掩码的特点
    长度 为 32 位的比特串
    左边部分有一连串比特 1，对应于网络号和子网号
    右边部分有一连串比特0，对应于主机号
  - 子网掩码的作用
    使用子网掩码与同一子网的IP地址进行相“与”运算（二进制逻辑与），可以得到该地址的子网号

- 无分类域间路由选择 CIDR 

  - (Classless Inter-Domain Routing)
  
  - 基本思想
    以可变长分块的方式分配所剩的C类网络
    它把划分子网的概念向相反的方向作了扩展
    通过借用前三个字节的几位可以把多个连续的C类地址集聚在一起，使得多条路由器条目汇聚成一条
    所有到达某一块C类地址的数据都被路由至某个路由器上
  使得路由器可以忽略网络类别(即C类)地址，按照目的地址和设定的掩码位数来确定映射的网络地址
  
  - 特点
    CIDR 消除了传统的 A 类、B 类和 C 类地址以及划分子网的概念，因而可以更加有效地分配 IPv4 的地址空间（主要是C类）
  CIDR使用不同长度的“网络前缀”(network-prefix)来代替分类地址中的网络号和子网号
  
- 表示
  
    CIDR 使用“斜线记法”(slash notation)
    它又称为 CIDR 记法，即在 IP 地址面加上一个斜线“/”，然后写上网络前缀所占的位数
    这个数值对应于三级编址中子网掩码中 1 的个数


### IP相关辅助协议

#### 地址解析协议ARP

- 通信时使用了两个地址：
  IP 地址（网络层及以上地址）
  MAC 地址（数据链路层地址）
- 为什么不直接使用硬件地址进行通信？
  - 由于全世界存在着各式各样的网络，它们使用不同的硬件地址。要使这些异构网络能够互相通信就必须进行非常复杂的硬件地址转换工作，因此几乎是不可能的事。
  - IP 编址把这个复杂问题解决了。连接到互联网的主机只需各自拥有一个唯一的 IP 地址，它们之间的通信就像连接在同一个网络上那样简单方便，因为上述的调用 ARP 的复杂过程都是由计算机软件自动进行的，对用户来说是看不见这种调用过程的。
  - 因此，在虚拟的 IP 网络上用 IP 地址进行通信给广大的计算机用户带来了很大的方便。

- ARP 作用：
  - 从网络层使用的 IP 地址，解析出在数据链路层使用的硬件地址
- 要点
  - 不管网络层使用的是什么协议，在实际网络的链路上传送数据帧时，最终还是必须使用硬件地址
  - 每一个主机都设有一个 ARP 高速缓存 (ARP cache)，里面有所在的局域网上的各主机和路由器的 IP 地址到硬件地址的映射表
- 过程
  - 当主机 A 欲向本局域网上的某个主机 B 发送 IP 数据报时，就先在其 ARP 高速缓存中查看有无主机 B 的 IP 地址。
    - 如有，就可查出其对应的硬件地址，再将此硬件地址写入 MAC 帧，然后通过局域网将该 MAC 帧发往此硬件地址。
    - 如没有， ARP 进程在本局域网上广播发送一个 ARP 请求分组。收到 ARP 响应分组后，将得到的 IP 地址到硬件地址的映射写入 ARP 高速缓存

#### 反向地址转换协议RARP

- 物理地址IP地址
  物理地址IP地址映射表
  广播方式

#### 动态主机配置协议DHCP

- (Dynamic Host Configuration Protocol) 提供了即插即用连网 (plug-and-play networking) 的机制。
- 这种机制允许一台计算机加入新的网络和获取 IP 地址，而不用手工配置。
- DHCP给运行服务器软件、且位置固定的计算机指派一个永久地址，给运行客户端软件的计算机分配一个临时地址

- 中继代理

  - 并不是每个网络上都有DHCP服务器，这样会使DHCP服务器的数量太多。现在是每一个网络至少有一个 DHCP 中继代理，它配置了 DHCP 服务器的 IP 地址信息。

    当 DHCP 中继代理收到主机发送的发现报文后，就以单播方式向 DHCP 服务器转发此报文，并等待其回答。收到 DHCP 服务器回答的提供报文后，DHCP 中继代理再将此提供报文发回给主机。

- 租用期(lease period)
  - DHCP 服务器分配给 DHCP 客户的 IP 地址的临时的，因此 DHCP 客户只能在一段有限的时间内使用这个分配到的 IP 地址。DHCP 协议称这段时间为租用期。 
    租用期的数值应由 DHCP 服务器自己决定。
    DHCP 客户也可在自己发送的报文中（例如，发现报文）提出对租用期的要求。 

#### 因特网控制报文协议ICMP

- 概述
  - IP不能提供可靠的服务，为了更有效地转发 IP 数据报和提高交付成功的机会，在网络层使用了网际控制报文协议 ICMP (Internet Control Message Protocol)来报告错误，并提供因特网中发生的最新情况给路由器。
  - ICMP是网络层比较重要的协议，主机或路由器报告差错情况和提供有关异常情况的报告。路由器主要利用该协议对数据报的传输过程进行监控。它也可以用来检测因特网，ICMP是在RFC792中定义的。
  - ICMP通过将信息封装在IP分组中，并设置报头的协议字段为1来发送信息。但ICMP是IP层协议的一部分，不是高层协议。
- ICMP差错报文提供差错报告，中间的路由器或目的端在处理IP报文时，如果发现错误，就向源端主机发送ICMP差错控制报文。主要包括
  - 目的无法到达(Destination Unreachable),用于报告多种原因造成的IP报文无法到达的错误。
  - 超时( Time Exceeded)。 当IP分组中的生存期TTL字段减到0或重装定时器（在收到分组的第一个段时设置）到期时发送超时分组。类型值为11，码值为0或l。0表示TTL超时，而1表示重组超时  
  - 参数问题(Parameter Problem)报文用于报告IP报文头的错误。

- ICMP相关命令－PING
  - Packet InterNet Groper

- ICMP相关命令－Tracert
  - Tracert（Windows下）和Traceroute（Unix下）是一个路由跟踪实用程序，用来跟踪一个分组从源点到终点的路径。确定 IP 数据报访问目标所经过的路由。Tracert 命令用 IP 生存时间字段TTL和 ICMP 错误消息来确定从一个主机到网络上其他主机的路由。 

### IPV6

- 提出原因
  - 32位的IPv4地址空间即将分配完毕  
  - 简化报头格式以加速包处理和包转发
  - 改变报头信息以提高QoS的处理能力
- 设计目标
  - 即使地址空间的分配效率不高，也能支持几十亿台主机
    降低路由表的大小
    简化协议，使路由器更快速
    提供更好的安全 认证 隐私
    更加关注服务类型 实时数据
    辅助制定范围内的组播
    主机漫游时无需改变地址
    允许协议向未来演进
    允许新老协议共存

- 特点
  - 简化的报头和灵活的扩展 
    层次化的地址结构 
    即插即用的连网方式 
    网络层的认证与加密 
    服务质量的满足 
    对移动通讯更好的支持

- 报文结构

  - 基本报头长度固定为40个字节，可以没有扩展报头，也可以有一个或多个扩展报头，扩展报头可以具有不同的长度

    ![IPV6报文结构](images\IPV6报文结构.jpg)

- 基本报头结构

  ![IPV6报头结构](images\IPV6报头结构.jpg)

  - 各字段含义
    - 版本。长度为4位，对于IPv6，该字段必须为6。
    - 类别。长度为8位，指明为该包提供了某种“区分服务”。RFC 1883中最初定义该字段只有4位，并命名为“优先级字段”，后来该字段的名字改为“类别”，在最新的IPv6 Internet草案中，称之为“业务流类别”。
    -  流标签。长度为2 0位，用于标识属于同一业务流的包。一个节点可以同时作为多个业务流的发送源。流标签、源节点地址、目的地址唯一标识了一个业务流。
    - 净荷长度。长度为16位，其中包括包净荷的字节长度，即IPv6头后的包中包含的字节数。
    -  下一个头。这个字段指出了IPv6头后所跟的头字段中的协议类型。(目前已定义了6种扩展头)若当前的头是最后一个IP头时,就指定该分组被传递给传输协议处理器(如TCP UDP)
    - 跳极限。长度为8位。每当一个节点对包进行一次转发之后，这个字段就会被减1。如果该字段达到0，这个包就将被丢弃。
    - 源地址。长度为128位，指出了IPv6包的发送方地址。
    - 目的地址。长度为128位，指出了IPv6包的接收方地址。这个地址可以是一个单播、组播或任意点播地址。如果使用了选路扩展头(其中定义了一个包必须经过的特殊路由)，其目的地址可以是其中某一个中间节点的地址而不必是最终地址。

- 扩展头部分类
  - 逐跳头：沿途所有路由器需检查的信息。
  - 目标选项扩展头：只需要在目标主机被翻译的域
  - 路由扩展头：列出在通向目标的途中必须访问的一台或多台路由器。类似于IPV4的宽松源路由机制
  - 分段扩展头：保存了数据报的标识符，分段号，分段标志。只有源主机可以对分组分段。
  - 认证扩展头：让分组接收方确定分组发送方的身份。

- 地址分配

  - 所有类型的IPv6地址都被分配到接口，而不是节点。IPv6地址为接口和接口组指定了128位的标识符，有三种类型的地址

    - 单播（Unicast）地址
            ① 未指定地址： 单播地址0:0:0:0:0:0:0:0 称为未指定地址。
            ② 回返地址：单播地址0:0:0:0:0:0:0:1 称为回返地址

    - 选播（AnyCast）地址

      一般属于不同节点的一组接口有一个标识符，发送给一个选播地址的包传送到该地址标识的、根据路由协议距离度量最近的一个接口上。IPv6选播地址存在下列限制： 选播地址不能用作源地址，而只能作为目的地址；选播地址不能指定给IPv6主机，只能指定给IPv6路由器。

    - 组播（MultiCast）地址

      一般属于不同节点的一组接口有一个标识符，发送给一个组播地址的包传递到该地址所标识的所有接口上。地址开始八位为1111 1111 标识该地址为组播地址。 IPv6中没有广播地址，它的功能正在被组播地址所代替

- 与IPV4比较

  - 头部比较
    没有Internet Head Length域,因为IPV6固定头部长度
    没有协议域,因为Next header域指明最后IP头部后跟的是什么
    与分段有关的域没有了.IPv6中主机能动态确定使用的数据报长度.当主机发送过大的分组时，路由器送回一条错误消息。主机直接发送大小合适的数据包
    校验和域没有了，因为计算校验和会极大降低性能，而数据链路层和传输层都有自己的校验和。
  - 使用了新版本的ICMPv6
    添加了额外的信息类型，比如“数据包过大”（“Packet Too Big”）
    增加了多播组管理函数

- 从IPv4过渡到IPv6

  - 不是所有的路由器都是同时更新到IPv6的
    不存在一个截止的时间节点
    网络如何在IPv4路由器和IPv6路由器共存的情况正常运行?

  - 两种技术： 
    隧道技术: 当IPv6数据包通过IPv4路由器时，将IPv6数据包当作IPv4数据包的载荷，在前面添加IPv4数据报头。

    ​         当IPv6数据包通过IPv4路由器时，将IPv6数据包当作IPv4数据包的载荷，在前面添加IPv4数据报头	

    双栈技术: 网络节点同时支持IPv4和IPv6协议栈

### 路由器

- 功能结构

  ![路由器功能](images\路由器功能.png)

- 路由器由网络接口、路由处理器、转发引擎和硬件交换器组成。
- 路由器主要完成两个功能：分组转发，路由计算
- “转发”和“路由选择”的区别  
  “转发”(forwarding)就是路由器根据转发表将用户的 IP 数据报从合适的端口转发出去。
  “路由选择”(routing)则是按照分布式算法，根据从各相邻路由器得到的关于网络拓扑的变化情况，动态地改变所选择的路由。
  路由表是根据路由选择算法得出的。而转发表是从路由表得出的。
  在讨论路由选择的原理时，往往不去区分转发表和路由表的区别

## ==传输层==

### 基本概念

- 传输层的两个不同的协议

  - 传输控制协议 TCP (Transmission Control Protocol)
  - 用户数据报协议 UDP (User Datagram Protocol)
  - 两个对等传输实体在通信时传送的数据单位叫作传输协议数据单元TPDU (Transport Protocol Data Unit)
    - TCP 传送的协议数据单元称为 TCP 报文段(segment)
    - UDP 传送的协议数据单元称为 UDP 报文或用户数据报

- 传输层服务

  - 传输层的最终目标是向应用层的进程，提供有效、可靠且价格合理的服务。
    为了达到这一目标，传输层利用了网络层所提供的服务。
    传输实体：完成传输层工作的实体。传输实体可能在操作系统内核中，或在一个单独的用户进程内，也可能包含在网络应用的程序库中，或是位于网络接口卡上。
    传输层有两种服务：面向连接的传输服务，无连接的传输服务
    面向连接服务包括三个阶段：建立连接、数据传输、释放连接
  - 从另一个角度来看，可以将传输层的主要功能看作是增强网络层提供的服务质量。
    若网络服务很完备，则传输层的工作就很容易；
    若网络服务很差，则传输层必须弥补传输用户的要求与网络层提供的服务之间的差别。
    传输服务允许用户在建立连接时对各种服务参数指定希望的、可接受的最低限度的值。
    传输层根据网络服务的种类或它能够获得的服务来检查这些参数，决定能否提供所要求的服务

- 关键指标

  连接建立延时：从传输服务用户要求建立连接到收到连接确认之间所经历的时间。包括远端传输实体的处理时间。
  连接建立失败的概率：在最大连接建立延时时间内连接未能建立的可能性。
  吞吐率：每秒传输的用户数据的字节数。
  传输延时：从源端机器传输用户发送报文开始到目的机器传输用户接收到报文为止所经历的时间。
  误码率：用于测量丢失或错乱报文数占整个发送的报文数的百分比

  安全保护：为传输用户提供了一种方法，让传输层防止未经授权的第三方读取或修改数据。
  优先级：为传输用户提供了一种用以表明哪些连接更为重要的方法，当发生拥塞事件时，确保高优先级的连接较低优先级的连接先获得服务。
  恢复功能：给出了当出现内部问题或拥塞情况下，传输层本身自发终止连接的可能性。

- 寻址

  当一个应用程序希望与一个远程应用程序建立连接时，必须指定与哪个应用程序相连，一般采用的方法是定义进程可以侦听连接请求的传输地址。
  在因特网中，使用（IP地址，本地端口）对。
  在传输层：传输服务访问点TSAP->本地端口
  在网络层：网络服务访问点NSAP->IP地址

- 流量控制和缓冲策略

  - 传输层中的流量控制问题在某些方面与数据链路层相同，但在另外一些方面有区别。

    基本相似之处：均需采用滑动窗口的流量控制机制。

    主要区别：路由器通常只有相对较少的连接线路，而主机则可以有很多个连接。
    这一区别决定了不可能在传输层中采用数据链路层中实施的缓冲策略

  - 缓存：由于网络层服务是不可靠的，传输层实体必须缓存所有连接发出的TPDU，而且为每个连接单独做缓存，以便用于错误情况下的重传。接收方的传输层实体既可以做，也可以不做缓存。
    流控：传输层利用可变滑动窗口协议来实现流控。所谓可变滑动窗口协议，是指发送方的发送窗口大小是由接收方根据自己的实际缓存情况给出的。为了避免控制TPDU丢失导致死锁，主机应该周期性的发送TPDU

- 复用和分解
  - 复用：指在发送方不同的应用进程都可以使用同一个传输层协议传送数据（当然需要加上适当的首部）；
    分解：指接收方的传输层在剥去报文的首部后能够把这些数据正确交付到目的应用进程。
    要能正确地将数据交付给指定应用进程，就必须给每个应用进程赋予一个明确的标志。
    在TCP/IP网络中，使用一种与操作系统无关的协议端口号(protocol port number)（简称端口号）来实现对通信的应用进程的标志。

- 端口
  - 端口：应用进程的传输层地址，用一个 16 位端口号标志
    端口的作用：让应用层的各种应用进程都能将其数据通过端口向下交付给传输层，以及让传输层知道应当将其报文段中的数据向上通过端口交付给应用层相应的进程。从这个意义上讲，端口是用来标志应用层的进程。
    端口号只具有本地意义，即端口号只是为了标志本计算机应用层中的各进程。在因特网中不同计算机的相同端口号是没有联系的，并且TCP和UDP端口号之间也没有必然联系
  - 熟知端口 ： 其数值一般为 0~1023。当一种新的应用程序出现时，必须为它指派一个熟知端口。
    登记端口 ： 其数值为 1024~49151。这类端口是互联网名称与数字地址分配机构ICANN 控制的，使用这个范围的端口必须在 ICANN 登记，以防止重复。
    动态端口 ： 其数值为 49152~65535。这类端口是留给客户进程选择作为临时端口。

### 用户数据报协议UDP

- User Datagram Protocol
- 概述
  - UDP 只在 IP 的数据报服务之上增加了很少一点的功能，即端口的功能和差错检测的功能。
    虽然 UDP 用户数据报只能提供不可靠的交付，但 UDP 在某些方面有其特殊的优点。
    发送数据之前不需要建立连接
    UDP 的主机不需要维持复杂的连接状态表。
    UDP 用户数据报只有 8 个字节的首部开销。
    网络出现的拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的。 
- 特点
  - UDP 是无连接的，即发送数据之前不需要建立连接（当然发送数据结束时也没有连接可释放），因此减少了开销和发送数据之前的时延。
  - UDP 使用尽最大努力交付，即不保证可靠交付，同时也不使用拥塞控制，因此主机不需要维持具有许多参数的、复杂的连接状态表。
  - 由于 UDP 没有拥塞控制，因此网络拥塞不会使源主机的发送速率降低。这对某些实时应用是很重要的，如 IP 电话、实时视频会议等要求源主机以恒定的速率发送数据，并且允许在网络发生拥塞时丢失一些数据，但却不允许数据有太大的时延。UDP 正好适合这种要求。
  - UDP 是面向报文的。这就是说，UDP 对应用程序交下来的报文不再划分为若干个分组来发送，也不把收到的若干个报文合并后再交付给应用程序。
    应用程序交给 UDP 一个报文，UDP 就发送这个报文；而 UDP 收到一个报文，就把它交付给应用程序。
    应用程序必须选择合适大小的报文。
  - UDP 支持一对一、一对多、多对一和多对多的交互通信。
    用户数据报只有 8 个字节的首部开销，比 TCP 的 20 个字节的首部要短。

- 问题

  - 虽然某些实时应用需要使用没有拥塞控制的 UDP，但当很多的源主机同时都向网络发送高速率的实时视频流时，网络就有可能发生拥塞，结果大家都无法正常接收。
  - 还有一些使用 UDP 的实时应用需要对UDP 的不可靠的传输进行适当的改进以减少数据的丢失。

- UDP头部格式

  ![UDP头部格式](images\UDP头部格式.png)

- UDP多路复用

  ![UDP多路复用](images\UDP多路复用.png)

### 传输控制协议TCP

- Transmission Control Protocol

- 概述

  - TCP 是面向连接的传输层协议。
    每一条 TCP 连接只能有两个端点(endpoint)，每一条 TCP 连接只能是点对点的（一对一）。 
    TCP 提供可靠交付的服务。
     TCP 提供全双工通信。
     面向字节流

    头部20字节

- 传输过程

  ![TCP传输过程](images\TCP传输过程.png)

- TCP连接

  - TCP 连接是一条虚连接而不是一条真正的物理连接。
    TCP 对应用进程一次把多长的报文发送到TCP 的缓存中是不关心的。
    TCP 根据网络的具体情况来决定一个报文段应包含多少个字节（UDP 发送的报文长度是应用进程给出的）。
    TCP 可把太长的数据块划分短一些再传送。TCP 也可等待积累有足够多的字节后再构成报文段发送出去

- 通信模式

  - TCP通信是全双工方式。
    发送方的应用进程按照自己产生数据的规律，不断地把数据块陆续写入到 TCP 的发送缓存中。TCP 再从发送缓存中取出一定数量的数据，将其组成 TCP 报文段(segment)逐个传送给 IP 层，然后发送出去。
    接收方从 IP 层收到 TCP 报文段后，先把它暂存在接收缓存中，然后让接收方的应用进程从接收缓存中将数据块逐个读取。 
  - 由于传输层的通信是面向连接的，因此TCP 每一条连接上的通信只能是一对一的，而不是一对多、多对一或多对多的。 
    TCP 把连接作为最基本的抽象。
    每一条 TCP 连接唯一地被通信两端的两个端点所确定

- TCP复用模式

  ![TCP复用模式](images\TCP复用模式.png)

- TCP头部格式

  ![TCP头部格式](images\TCP头部格式.png)

### TCP可靠传输

- 背景
  - 因特网的网络层服务是不可靠的，即通过IP传送的数据可能出现差错、丢失、乱序或重复。
  - TCP在IP的不可靠的尽最大努力服务的基础上实现了一种可靠数据传输服务，保证数据无差错、无丢失、按序和无重复的交付。
  - 由于TCP下面的传输数据的互联网的结构非常复杂，因此不能采用最简单的停止等待协议来实现可靠传输
- 数字序列号和确认
  - TCP 协议是面向字节的。TCP 将所要传送的报文看成是字节组成的数据流，并使每一个字节对应于一个序号。
  - 在连接建立时，双方要商定初始序号。TCP 每次发送的报文段的首部中的序号字段数值表示该报文段中的数据部分的第一个字节的序号。
  -  TCP 的确认是对接收到的数据的最高序号表示确认。接收方返回的确认号是已收到的数据的最高序号加 1。因此确认号表示接收方期望下次收到的数据中的第一个数据字节的序号。  
  - 由于TCP连接能提供全双工通信，因此通信中的每一方都不必专门发送确认报文段，而可以在传送数据时顺便把确认信息捎带传送
  - 为此，接收方在正确接收到数据时可能要等待一小段时间（不能超过0.5秒）再发送确认，若这段时间内有数据要发送给对方，则采用捎带确认。这样做可以提高传输效率。
  - 接收方若收到有差错的报文段就丢弃（不发送否认信息）。
  - 若收到重复的报文段，也要丢弃，但要发回（或捎带发回）确认信息。
  - 若收到失序的报文段，可选择将失序报文段丢弃，或者先将其暂存于接收缓存内，待所缺序号的报文段收齐后再一起上交应用层。注意，不论采用哪种方法，接收方都要对已按序接收到的数据进行确认
- 滑动窗口
  - TCP 采用大小可变的滑动窗口进行流量控制。窗口大小的单位是字节。
  - 在 TCP 报文段首部的窗口字段写入的数值就是当前给对方设置的发送窗口数值的上限。
  - 发送窗口在连接建立时由双方商定。但在通信的过程中，接收方可根据自己的资源情况，随时动态地调整对方的发送窗口上限值(可增大或减小)
- 超时重传
  - 重传机制是 TCP 中最重要和最复杂的问题之一。
  - TCP 每发送一个报文段，就对这个报文段设置一次计时器。只要计时器设置的重传时间到但还没有收到确认，就要重传这一报文段

- 快速重传
  - 要求接收方每收到一个失序的报文段后就立即发出重复确认。
  - 发送方只要一连收到三个重复确认就应当立即重传对方尚未收到的报文段。 
  - 不难看出，快重传并非取消重传计时器，而是在某些情况下可更早地重传丢失的报文段。

- 选择确认
  - 选择确认SACK (Selective ACK) 允许接收方通知发送方所有正确接收了的但是失序的字节块，发送方可以根据这些信息只重传那些接收方还没有收到的字节块。
  - TCP在首部中提供了一个可变长的“SACK选项字段”来存放接收到的失序字节块的信息
  - 在建立TCP连接时，通过添加“允许SACK选项字段”首部选项，表示都支持选择确认功能

- 流量控制
  - 如果发送方把数据发送得过快，接收方就可能来不及接收，这就会造成数据的丢失。
  - 流量控制(flow control)就是让发送方的发送速率不要太快，即要让接收方来得及接收。
  - 利用滑动窗口机制可以很方便地在 TCP 连接上实现流量控制
- 连接和释放
  - 都要经过建立连接、传输数据、释放连接
  - 三次握手和四次挥手

### 网络层拥塞控制。。

- 基本原理
     	网络中存在过多分组的时候，网络性能降低，产生拥塞。

  - 开环控制 (通过良好的设计解决问题)
    拥塞预防策略：数据链路层、网络层、传输层都策略可以进行预防
    通信量整形
    强迫分组以某种可以预见的速率传送。
    漏桶和令牌桶均可实现通信量整形
  - 闭环控制 （通过反馈发现并解决问题）
    虚电路网络中的拥塞控制
    许可控制、绕开拥塞、资源预留
    抑制分组：向源主机发送抑制分组。
    为了得到快速的抑制效果，可采用Hop-by-Hop抑制分组，抑制分组对其所经过的路由器都起作用

- 拥塞避免设计策略

  - 传输层：重传、乱序缓存、确认、流控、超时中止
  -  网络层：子网中的虚电路和数据报、分组排队和服务策略、分组丢弃策略、路由算法、分组的生存时间管理

- 网络层？通信量整形

  - (Traffic Shaping)的基本思想
    网络上，突发的通信量是造成拥塞的主要原因。
    强迫分组以某种可以预见的速率传送，减少拥塞，这种方法就被称为通信量整形

  - 漏桶算法(The Leaky Bucket Algorithm)
    漏桶——有限内部队列；水 —— 通信量，需要发送的分组。
    分组到达队列时，队列满，分组被丢弃；队列有存放空间，分组放置在队尾。
  - 令牌桶算法
    基本思想：为提高灵活性，桶中存放令牌，每T 秒产生一个令牌，分组发送传输之前必须获得一个令牌，传输之后删除该令牌。
    令牌代表的不是发送一个分组的权利，而是可以发送的字节数
  - 对比
    - 通信量整形策略不同
      漏桶算法不允许空闲主机积累发送权。
      令牌桶算法允许空闲主机积累发送权，以便以后发送大的突发数据，最大为桶的大小。
    - 桶中存放的内容不同
      漏桶中存放的是数据，桶满了丢弃数据。
      令牌桶中存放的是令牌，桶满了丢弃令牌，不丢弃数据

- 虚电路子网中的拥塞控制

  - 方法一：许可控制(admission control)：一旦发生拥塞，就不允许再建立新的虚电路，直到拥塞解除为止。
  - 方法二：在发生拥塞后可以建立新的虚电路，但要绕开发生拥塞的地区。
  - 方法三：资源预留：建立虚电路时，主机与子网达成协议，子网根据协议在虚电路上为此连接预留资源

- 抑制分组

  - 路由器监控输出线路及其它资源的利用情况，超过某个阈值，则此资源进入警戒状态。
  - 每个新分组到来，检查它的输出线路是否处于警戒状态。若是，向源主机发送抑制分组，分组中指出发生拥塞的目的地址。同时将源分组打上标记(为了以后不再产生抑制分组)后，正常转发。
  - 源主机收到抑制分组后，按一定比例减少发向特定目的地的通信量，并在固定时间间隔内忽略指示同一目的地的抑制分组。然后开始监听，若此线路仍然拥塞，则主机在固定时间内减轻负载、忽略抑制分组；若在监听周期内没有收到抑制分组，则增加通信量

- 负载丢弃
  - 当以上任何一种方法都不能消除拥塞时，路由器就采用负载脱落。
    到底应该丢弃哪些分组，这应该取决于所运行的应用的类型。
    要实现智能的丢弃策略，应用程序必须在它们的分组中表明优先级
- 随机的早期检测
  - RED：在实际耗尽所有的缓冲区空间之前就开始丢弃分组。
    在有些传输协议（如TCP）中，针对分组丢弃的响应措施是源主机减慢传输速度。依据是：TCP针对有线网设计的，而有线网非常可靠，所以，分组丢弃的主要原因是缓冲满了，而非传输错误。
  - 为了确定该什么时候开始丢弃分组，路由器维护了最近队列的平均长度。当超过一定阈值时，该线路被认定拥塞，从而采取措施。
  - 由于路由器无法判定是哪个源引起的，因此，只能从拥塞队列中随机选取分组
- 抖动控制
  - 抖动：分组到达时间的变化量（即标准差）
  - 对抖动的控制：当一个分组到达一个路由器时，检查它比预定时间来早了还是来晚了，这些信息保存在分组中，每一跳都更新。
  - 若来早了，则多停留一些时间再转发，以便回到预定时间点。若来晚了，则路由器尽可能快地将它转发出去。
  - 对抖动控制的前提：计算出沿途每一跳的期望传输时间。
  - 对于多个正在竞争同一输出线路的分组，所使用的算法总是选择偏离预定时间最远的分组优先转发，这样提前到达的就会减速，而落后的会加速。无论哪种情况，都可以减缓抖动的程度

### 网络地址转换NAT

- Network Address Translation
- 背景
  - 需要在专用网连接到互联网的路由器上安装 NAT 软件。装有 NAT 软件的路由器叫做 NAT路由器，它至少有一个有效的外部全球IP地址。
  - 所有使用本地地址的主机在和外界通信时，都要在 NAT 路由器上将其本地地址转换成全球 IP 地址，才能和互联网连接
- 技术实现
  - 现在常用的 NAT 转换表把传输层的端口号也利用上。这样，就可以使多个拥有本地地址的主机，共用一个 NAT 路由器上的全球 IP 地址，因而可以同时和互联网上的不同主机进行通信。
  - 使用端口号的 NAT 叫做网络地址与端口号转换NAPT (Network Address and Port Translation)
  - NAPT把专用网内不同的源 IP 地址，都转换为同样的全球 IP 地址。但对源主机所采用的 TCP 端口号（不管相同或不同），则转换为不同的新的端口号。
  - 因此，当 NAPT 路由器收到从互联网发来的应答时，就可以从 IP 数据报的数据部分找出传输层的端口号，然后根据不同的目的端口号，从 NAPT 转换表中找到正确的目的主机

- 缺陷
  - 违反了IP的结构模型，许多台机器用同样的内部地址

  - NAT盒保留了连接的状态，NAT崩溃,所有TCP连接被破坏
  -  NAT的映射由出境数据包建立，只有先有出境数据包才能接受入境数据包。要访问网络内部的服务器，需特殊的配置或NAT穿越技术。
  -  违反了基本的协议分层原则
  -  Internet的进程不一定总是使用TCP或者UDP
  -  有些应用会在正文内容中插入IP地址,接收方从正文中提取并使用.
  -  TCP端口域是16位,只能最多有65536台机器映射到同一台机器

## ==应用层==

### 概述

- 应用层协议定义了客户端和服务器端之间是如何传递信息的

- 应用层协议所需的传输层服务

  ![应用层协议对应的传输层服务](images\应用层协议对应的传输层服务.png)

- 两种服务模式

  - 客户-服务器模式（Client-Server，CS）
    - 服务器: 
      一直在运行
      拥有永久IP地址
    - 客户:
      主动发起到服务器的通信
      可能是间断性连接到网络
      可能是动态IP地址
      客户之间不相互通信
  - 对等模式（Peer-to-Peer, P2P）
    - 没有一直在运行的服务器
      任意两个端设备可以直接通信
      对等方通常是间断性连接到网上，并且可能改变IP地址
      通常用于文件分发等应用
    - 可伸缩性好，但是通常难以管理

### 万维网

- 概述
  - 使用统一资源定位URL(uniform resource locator)来标识万维网上的各种文档，并使每一个文档在整个因特网的范围内具有唯一的标志符URL
  - 万维网客户程序与万维网服务器程序之间的交互遵守严格的协议，这就是超文本传送协议HTTP(hypertext transfer protocol)
  - 使用超文本标记语言HTML(Hypertext Markup Language) ，让不同风格的万维网文档都能在因特网上的各种计算机上显示出来
  - 用户可使用各种搜索工具查找信息

### HTTP协议

- 请求方式

  ![HTTP请求方式](images\HTTP请求方式.png)

- 请求和响应头

  ![HTTP请求和响应头](images\HTTP请求和响应头.png)

- 响应状态码

  ![HTTP响应状态码](images\HTTP响应状态码.png)

### Ajax技术

- 传统的Web应用
  - 用户端填写表单(form)->向Web服务器发送一个请求->服务器接收并处理传来的表单，送回一个新的网页。
  - 缺点：
    浪费带宽，因为在前后两个页面中的大部分HTML代码往往是相同的。
    响应慢，由于每次应用的交互都需要向服务器发送请求，应用的响应时间就依赖于服务器的响应时间。导致了用户界面的响应比本地应用慢得多。
- AJAX应用
  - 可以仅向服务器发送并取回必需的数据，它使用SOAP或其它一些基于XML的页面服务接口，并在客户端采用JavaScript处理来自服务器的响应。

  - 优势：使得在服务器和浏览器之间交换的数据大量减少（大约只有原来的5%），响应更快。节省Web服务器的处理时间，很多的处理工作可以在客户端机器上完成

### 域名服务DNS

- Domain Name System

- 概述

  - DNS本质上是一个由很多名称服务器主机构成的层次结构的分布式数据库系统，允许客户主机和名称服务器主机通信以使用域名转换服务
  - 域名服务器主机通常是运行Berkeley Internet Name Domain(简称BIND)软件的Unix主机。DNS协议运行在UDP之上，使用端口号53

  - ¨因特网采用了层次树状结构的命名方法。
  - 任何一个连接在因特网上的主机或路由器，都有一个唯一的层次结构的名字，即域名
  - 域名只是个逻辑概念，并不代表计算机所在的物理地点
  - 变长的域名和使用有助记忆的字符串，是为了便于人来使用。而 IP 地址是定长的 32 位二进制数字则非常便于机器进行处理

- 结构

  - … **.** 三级域名 **.** 二级域名 **.** 顶级域名

- 顶级域名

  - 国家顶级域名 nTLD：如: .cn 表示中国，.us 表示美国，.uk 表示英国，等等。
  - 通用顶级域名 gTLD：最早的顶级域名是：
        .com  （公司和企业）
        .net  （网络服务机构）
        .org  （非赢利性组织）
        .edu  （美国专用的教育机构）
        .gov  （美国专用的政府部门）
  - 基础结构域名(infrastructure domain)：这种顶级域名只有一个，即 ARPA网，用于反向域名解析，因此又称为反向域名

  ![各级域名](images\各级域名.png)

- 常见域名

  ![常用域名](images\常用域名.png)

- 域名服务器

  - 每一个区设置相应的权限域名服务器，用来保存该区中的所有主机的域名到IP地址的映射

  - 分类

    - ¨根域名服务器 

      - 最重要的域名服务器。所有的根域名服务器都知道所有的顶级域名服务器的域名和 IP 地址

      - 在因特网上共有13 个不同 IP 地址的根域名服务器，它们的名字是用一个英文字母命名，从a 一直到 m

        - 分别是

          a.rootservers.net
          b.rootservers.net
              …    

          m.rootservers.net

    - ¨顶级域名服务器 

      - 负责管理在该顶级域名服务器注册的所有二级域名

    - ¨权限域名服务器 

      - 负责一个区的域名服务器

    - ¨本地域名服务器 

      - 当一个主机发出 DNS 查询请求时，这个查询请求报文首先就发送给本地域名服务器

  - 本地递归查询，其他递归查询，查找到则返回

    ![域名的迭代和递归查询](images\域名的迭代和递归查询.png)

- 域名服务器都维护一个高速缓存，存放最近用过的名字以及从何处获得名字映射信息的记录，提高查找效率

- 第一步：客户机提出域名解析请求,并将该请求发送给本地的域名服务器

  第二步：当本地的域名服务器收到请求后,就先查询本地的缓存,如果有该纪录项,则本地的域名服务器就直接把查询的结果返回.

  第三步：如果本地的缓存中没有该纪录,则本地域名服务器就直接把请求发给根域名服务器,然后根域名服务器再返回给本地域名服务器一个所查询域(根的子域)的主域名服务器的地址.

  第四步：本地服务器再向上一步返回的域名服务器发送请求,然后接受请求的服务器查询自己的缓存,如果没有该纪录,则返回相关的下级的域名服务器的地址.

  第五步：重复第四步,直到找到正确的纪录.

  第六步：本地域名服务器把返回的结果保存到缓存,以备下一次使用,同时还将结果返回给客户机.

- DNS可以解析端口吗？

  - DNS只解析ip，端口是服务提供的

### 电子邮件协议

- 概述
  - 电子邮件(e-mail)是因特网上使用得最多的和最受用户欢迎的一种应用。
    电子邮件把邮件发送到收件人使用的邮件服务器，并放在其中的收件人邮箱中，收件人可随时上网到自己使用的邮件服务器进行读取。
    电子邮件不仅使用方便，而且还具有传递迅速和费用低廉的优点。
    现在电子邮件不仅可传送文字信息，而且还可附上声音和图像
- 协议
  - 发送邮件的协议：SMTP
    读取邮件的协议：POP3 和 IMAP

- 过程

  ![邮件发送过程](images\邮件发送过程.png)

- 组成

  - 电子邮件由信封(envelope)和内容(content)两部分组成

- 首部

  - ¨“To:”后面填入一个或多个收件人的电子邮件地址。用户只需打开地址簿，点击收件人名字，收件人的电子邮件地址就会自动地填入到合适的位置上。

    ¨ “Subject:”是邮件的主题。它反映了邮件的主要内容，便于用户查找邮件。

    ¨抄送 “Cc:” 表示应给某某人发送一个邮件副本。

    “From” 和 “Date” 表示发信人的电子邮件地址和发信日期。“Reply-To” 是对方回信所用的地址

- 基于万维网的电子邮件

  ![基于万维网的电子邮件](images\基于万维网的电子邮件.png)

### 文件传送协议FTP

- 概述
  - 因特网上使用得最广泛的文件传送协议。
  - FTP 提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取权限。
  - FTP 屏蔽了各计算机系统的细节，因而适合于在异构网络中任意计算机之间传送文件

- 网络环境下复制文件的复杂性：
  (1) 计算机存储数据的格式不同。
  (2) 文件的目录结构和文件命名的规定不同。
  (3) 对于相同的文件存取功能，操作系统使用的命令不同。
  (4) 访问控制方法不同

- FTP 使用的两个 TCP 连接 

  - 当客户进程向服务器进程发出建立连接请求时，要寻找连接服务器进程的熟知端口(21)，同时还要告诉服务器进程自己的另一个端口号码，用于建立数据传送连接。
  - 接着，服务器进程用自己传送数据的熟知端口(20)与客户进程所提供的端口号码建立数据传送连接

  ![FTP两个进程](images\FTP两个进程.png)

### 其他文件传输协议

- NFS (Network File System) 
  - 允许应用进程打开一个远地文件，并能在该文件的某一个特定的位置上开始读写数据。
    NFS 可使用户只复制一个大文件中的一个很小的片段，而不需要复制整个大文件。
    对于上述例子，计算机 A 的 NFS 客户软件，把要添加的数据和在文件后面写数据的请求一起发送到远地的计算机 B 的 NFS 服务器。NFS 服务器更新文件后返回应答信息。
    在网络上传送的只是少量的修改数据
- TFTP 
  - 一个很小且易于实现的文件传送协议。
    TFTP 使用客户服务器方式和使用 UDP 数据报，因此 TFTP 需要有自己的差错改正措施。
    TFTP 只支持文件传输而不支持交互。
    TFTP 没有一个庞大的命令集，没有列目录的功能，也不能对用户进行身份鉴别