## NIO

- Java New IO
  - Java新的IO方式
  - 支持面向缓冲区的、基于通道的IO操作。NIO将以更加高效的方式进行文件的读写操作。
  - 缓冲区负责存储，通道负责传输

- 与传统IO相比
  - NIO
    - 面向缓冲区，非阻塞
    - 数据块为单位，双向传输
  - 传统IO
    - 面向流，阻塞
    - 以二进制或字符为单位，单向传输

- 三大组件
  - Selector
    - 同时监控多个SelectableChannel 的IO 状况，
    - 一个单独的线程管理多个Channel
    - 是非阻塞IO 的核心
  - Channel
    - 表示IO 源与目标打开的连接。具有独立处理IO的处理器
      - 使用DMA（直接存储器，处理IO操作时，会请求获取总线的使用权
    - 一个Channel可以管理多个Buffer
  - Buffer
    - 类似于一个数组
    - 分类
      - 直接缓冲区
        - **allocate()**方法获取的缓冲区，建立在JVM堆内存之中
        - 数据方向：磁盘->操作系统->JVM
      - 非直接缓冲区
        - allocateDirect()获取的缓冲区，建立在操作系统内存之中
        - 在操作系统和JVM之间创建物理内存映射文件，
        - 数据流向：磁盘->操作系统
        - 读写速度更快

## 阻塞、非阻塞、多路复用

- 阻塞
  - 传统的IO 流都是阻塞式的
  - 当一个线程调用read() 或write() 时，在此线程期间不能执行其他任务。但CPU还能给其他线程工作
  - 网络通信时，服务器要为每个客户端都提供一个独立的线程进行处理，性能急剧下降
  - 优缺点
    - 优点
      - 阻塞时不消耗cpu资源，被阻塞的线程不占用CPu
      - 实现难度低，适合并发量小的网络开发
    - 缺点
      - 每个请求都会分配一个线程，频繁线程创建、切换、销毁，系统开销大

- 非阻塞
  - 当线程从某通道进行读写数据，没数据可用时，该线程可进行其他任务。
  - 单独的线程可以管理多个输入和输出通道
  - 网络同行时，少量线程可同时处理多个客户端请求
  - 特点
    - 进行监控的进程要一直while(true)轮询调用，cpu消耗大

- 多路复用
  - 选择器
    - 是多路复用IO 的核心
  - 优缺点
    - 优点
      - 请求IO的线程可以在IO时执行其他任务，降低响应时间
    - 缺点
      - Selector的进程不用轮询调用，有可读写事件时才通知线程

## 粘包与半包

- 理想状态
  - 发送方发送一条消息，接收方就接收一条消息。不需要额外处理

- 粘包
  - 发送方缓冲区过大，多条消息在同一缓冲区一起发出去。导致接收方一次收到多条消息的现象
- 半包
  - 接收方缓冲区过小，只能接收消息的一部分，造成消息截断的现象

- 解决办法
  - 加入分隔符，遇到分隔符则表示消息结尾
    - 优点：
      - 实现简单
    - 缺点：
      - 要一个一个字符比较，效率低
  - 约定好长度，消息小于等于约定长度，不足时对数据进行填充
    - 优点
      - 处理速度快 
    - 缺点：短消息浪费带宽
  - TLV 格式
    - 即 Type 类型、Length 长度、Value 数据